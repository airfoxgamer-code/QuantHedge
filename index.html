<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QuantHedge — Private Investment Terminal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Montserrat:wght@300;400;500;600&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:        #0c0c0e;
  --bg2:       #111114;
  --bg3:       #16161a;
  --card:      #111114;
  --border:    rgba(255,255,255,0.07);
  --border2:   rgba(255,255,255,0.12);
  --gold:      #c9a84c;
  --gold2:     #e8c97a;
  --gold3:     rgba(201,168,76,0.15);
  --silver:    #a0a8b8;
  --white:     #f0efe8;
  --text:      #d4d0c8;
  --text2:     #7a7870;
  --text3:     #3a3830;
  --green:     #4caf7d;
  --red:       #c0524a;
  --blue:      #5a7fa8;
  --glow:      0 0 40px rgba(201,168,76,0.12);
}

body.light {
  --bg:        #f5f3ee;
  --bg2:       #edeae2;
  --bg3:       #e4e0d5;
  --card:      #ffffff;
  --border:    rgba(0,0,0,0.08);
  --border2:   rgba(0,0,0,0.14);
  --gold:      #8a6820;
  --gold2:     #6a5018;
  --gold3:     rgba(138,104,32,0.1);
  --silver:    #5a5850;
  --white:     #1a1814;
  --text:      #2a2820;
  --text2:     #6a6860;
  --text3:     #aaa898;
  --green:     #2d7a50;
  --red:       #9a3830;
  --blue:      #3a5f88;
  --glow:      0 4px 24px rgba(0,0,0,0.08);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Montserrat', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  transition: background 0.4s, color 0.4s;
}

/* Subtle grain texture */
body::before {
  content:'';
  position:fixed;
  inset:0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events:none;
  z-index:9998;
  opacity:0.4;
}

/* ── PASSWORD SCREEN ── */
#pw-screen {
  position:fixed; inset:0; z-index:10000;
  background: #08080a;
  display:flex; align-items:center; justify-content:center;
  flex-direction:column;
}

.pw-bg {
  position:absolute; inset:0;
  background: radial-gradient(ellipse 60% 60% at 50% 50%, rgba(201,168,76,0.04) 0%, transparent 70%);
}

.pw-line-top, .pw-line-bottom {
  position:absolute; left:0; right:0; height:1px;
  background: linear-gradient(90deg, transparent, rgba(201,168,76,0.3), transparent);
}
.pw-line-top { top:80px; }
.pw-line-bottom { bottom:80px; }
.pw-line-left, .pw-line-right {
  position:absolute; top:0; bottom:0; width:1px;
  background: linear-gradient(180deg, transparent, rgba(201,168,76,0.3), transparent);
}
.pw-line-left { left:80px; }
.pw-line-right { right:80px; }

.pw-inner {
  position:relative; z-index:2;
  display:flex; flex-direction:column; align-items:center;
  gap:40px; text-align:center;
  animation: elegantReveal 1.6s cubic-bezier(0.16,1,0.3,1) forwards;
}

@keyframes elegantReveal {
  from { opacity:0; transform:translateY(24px); }
  to   { opacity:1; transform:translateY(0); }
}

.pw-monogram {
  width:72px; height:72px;
  border:1px solid rgba(201,168,76,0.4);
  display:flex; align-items:center; justify-content:center;
  font-family:'Cormorant Garamond', serif;
  font-size:28px; font-weight:300;
  color: #c9a84c;
  letter-spacing:4px;
  position:relative;
}
.pw-monogram::before, .pw-monogram::after {
  content:'';
  position:absolute;
  width:8px; height:8px;
  border-color: rgba(201,168,76,0.4);
  border-style:solid;
}
.pw-monogram::before { top:-1px; left:-1px; border-width:1px 0 0 1px; }
.pw-monogram::after  { bottom:-1px; right:-1px; border-width:0 1px 1px 0; }

.pw-wordmark {
  font-family:'Cormorant Garamond', serif;
  font-size:42px; font-weight:300;
  color: #f0efe8;
  letter-spacing:12px;
  text-transform:uppercase;
  line-height:1;
}

.pw-tagline {
  font-size:10px; font-weight:500;
  color: rgba(201,168,76,0.6);
  letter-spacing:5px;
  text-transform:uppercase;
  margin-top:-28px;
}

.pw-rule {
  width:200px; height:1px;
  background: linear-gradient(90deg, transparent, rgba(201,168,76,0.4), transparent);
}

.pw-label {
  font-size:9px; font-weight:600;
  color: var(--text2);
  letter-spacing:4px;
  text-transform:uppercase;
  margin-bottom:-28px;
}

.pw-input {
  background:transparent;
  border:none;
  border-bottom:1px solid rgba(201,168,76,0.3);
  color: #c9a84c;
  font-family:'DM Mono', monospace;
  font-size:20px; font-weight:300;
  letter-spacing:12px;
  padding:12px 0;
  width:220px; text-align:center;
  outline:none;
  transition:border-color 0.3s;
}
.pw-input:focus { border-bottom-color: rgba(201,168,76,0.8); }
.pw-input.pw-error { border-bottom-color: var(--red); color: var(--red); animation: shake 0.4s ease; }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }

.pw-submit {
  background:transparent;
  border:1px solid rgba(201,168,76,0.35);
  color: #c9a84c;
  font-family:'Montserrat', sans-serif;
  font-size:9px; font-weight:600;
  letter-spacing:5px;
  text-transform:uppercase;
  padding:14px 40px;
  cursor:pointer;
  transition:all 0.35s;
  position:relative; overflow:hidden;
}
.pw-submit::before {
  content:'';
  position:absolute; inset:0;
  background: rgba(201,168,76,0);
  transition: background 0.35s;
}
.pw-submit:hover::before { background: rgba(201,168,76,0.08); }
.pw-submit:hover { border-color: rgba(201,168,76,0.7); letter-spacing:7px; }

.pw-err-msg {
  font-size:9px; font-weight:500;
  color: var(--red);
  letter-spacing:3px;
  text-transform:uppercase;
  height:14px;
}

.pw-footer-text {
  font-size:8px; font-weight:500;
  color: rgba(255,255,255,0.1);
  letter-spacing:3px;
  text-transform:uppercase;
  position:absolute; bottom:40px;
}

/* ── INTRO SLIDESHOW ── */
#intro-show {
  display:none;
  position:fixed; inset:0; z-index:9999;
  background: #08080a;
  overflow:hidden;
}

.ss-bg {
  position:absolute; inset:0;
  background: radial-gradient(ellipse 80% 80% at 50% 50%, rgba(201,168,76,0.03) 0%, transparent 70%);
}

.ss-corner {
  position:absolute;
  width:60px; height:60px;
  border-color: rgba(201,168,76,0.2);
  border-style:solid;
}
.ss-corner.tl { top:40px; left:40px; border-width:1px 0 0 1px; }
.ss-corner.tr { top:40px; right:40px; border-width:1px 1px 0 0; }
.ss-corner.bl { bottom:40px; left:40px; border-width:0 0 1px 1px; }
.ss-corner.br { bottom:40px; right:40px; border-width:0 1px 1px 0; }

.slide {
  position:absolute; inset:0;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  opacity:0; transition:opacity 0.9s ease;
  padding:80px; text-align:center; gap:28px;
  z-index:1;
}
.slide.active { opacity:1; }

.slide-eyebrow {
  font-size:9px; font-weight:600;
  color: rgba(201,168,76,0.5);
  letter-spacing:6px;
  text-transform:uppercase;
}

.slide-heading {
  font-family:'Cormorant Garamond', serif;
  font-size:56px; font-weight:300;
  color: #f0efe8;
  letter-spacing:4px;
  line-height:1.1;
}
.slide-heading em { font-style:italic; color:#c9a84c; }

.slide-body {
  font-size:14px; font-weight:300;
  color: rgba(210,208,200,0.6);
  max-width:520px;
  line-height:1.9;
  letter-spacing:0.5px;
}

.slide-rule {
  width:40px; height:1px;
  background: rgba(201,168,76,0.4);
}

.slide-stats {
  display:flex; gap:64px;
  margin-top:8px;
}
.slide-stat-item { text-align:center; }
.slide-stat-num {
  font-family:'Cormorant Garamond', serif;
  font-size:40px; font-weight:300;
  color: #c9a84c;
}
.slide-stat-lbl {
  font-size:9px; font-weight:600;
  color: rgba(255,255,255,0.25);
  letter-spacing:3px;
  text-transform:uppercase;
  margin-top:6px;
}

.ss-progress {
  position:absolute; bottom:48px; left:50%; transform:translateX(-50%);
  display:flex; gap:12px; z-index:2;
}
.ss-dot {
  width:24px; height:1px;
  background: rgba(255,255,255,0.15);
  transition:all 0.5s;
}
.ss-dot.active {
  background: rgba(201,168,76,0.7);
  width:40px;
}

.ss-skip {
  position:absolute; bottom:40px; right:48px; z-index:2;
  background:transparent; border:none;
  font-family:'Montserrat', sans-serif;
  font-size:9px; font-weight:500;
  color: rgba(255,255,255,0.2);
  letter-spacing:3px; text-transform:uppercase;
  cursor:pointer; transition:color 0.3s;
}
.ss-skip:hover { color:rgba(201,168,76,0.6); }

/* ── HEADER ── */
header {
  position:sticky; top:0; z-index:100;
  background: rgba(12,12,14,0.94);
  backdrop-filter: blur(20px);
  border-bottom:1px solid var(--border);
  padding:0 48px;
  height:68px;
  display:flex; align-items:center; gap:32px;
}

body.light header { background: rgba(245,243,238,0.96); }

.logo-area {
  display:flex; align-items:center; gap:14px;
  flex-shrink:0;
  text-decoration:none;
}

.logo-mark {
  width:34px; height:34px;
  border:1px solid rgba(201,168,76,0.4);
  display:flex; align-items:center; justify-content:center;
  font-family:'Cormorant Garamond', serif;
  font-size:14px; font-weight:300;
  color: var(--gold);
  letter-spacing:1px;
}

.logo-name {
  font-family:'Cormorant Garamond', serif;
  font-size:20px; font-weight:300;
  color: var(--white);
  letter-spacing:6px;
  text-transform:uppercase;
}

.header-divider {
  width:1px; height:24px;
  background: var(--border2);
}

.search-wrap {
  flex:1; max-width:420px;
  display:flex; align-items:center; gap:0;
  border-bottom:1px solid var(--border2);
  transition:border-color 0.3s;
}
.search-wrap:focus-within { border-bottom-color: var(--gold); }

.search-wrap input {
  flex:1;
  background:transparent;
  border:none;
  color: var(--white);
  font-family:'DM Mono', monospace;
  font-size:15px; font-weight:300;
  letter-spacing:4px;
  text-transform:uppercase;
  padding:10px 0;
  outline:none;
}
.search-wrap input::placeholder { color:var(--text3); font-size:11px; letter-spacing:3px; }

.btn-analyze {
  background:transparent;
  border:none;
  color: var(--gold);
  font-family:'Montserrat', sans-serif;
  font-size:9px; font-weight:600;
  letter-spacing:4px;
  text-transform:uppercase;
  padding:8px 16px;
  cursor:pointer;
  transition:all 0.3s;
  flex-shrink:0;
}
.btn-analyze:hover { color:var(--gold2); }
.btn-analyze:disabled { opacity:0.3; cursor:not-allowed; }

.header-right {
  margin-left:auto;
  display:flex; align-items:center; gap:20px;
}

.theme-btn {
  background:transparent; border:none;
  width:32px; height:32px;
  cursor:pointer; color:var(--text2);
  font-size:14px; display:flex;
  align-items:center; justify-content:center;
  transition:color 0.3s;
}
.theme-btn:hover { color:var(--gold); }

.status-text {
  font-size:9px; font-weight:500;
  color:var(--text3); letter-spacing:3px;
  text-transform:uppercase;
  font-family:'DM Mono', monospace;
}

.status-dot {
  display:inline-block;
  width:5px; height:5px; border-radius:50%;
  background:var(--green);
  margin-right:8px;
  animation:pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* ── MAIN ── */
main {
  max-width:1520px;
  margin:0 auto;
  padding:40px 48px;
  position:relative; z-index:1;
}

/* ── WELCOME ── */
#welcome-screen {
  min-height:72vh;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center; gap:32px;
}

.welcome-headline {
  font-family:'Cormorant Garamond', serif;
  font-size:72px; font-weight:300;
  color: var(--white);
  letter-spacing:6px;
  line-height:1.05;
}
.welcome-headline em { font-style:italic; color:var(--gold); }

.welcome-sub {
  font-size:10px; font-weight:600;
  color:var(--text2); letter-spacing:6px;
  text-transform:uppercase;
}

.welcome-rule {
  width:60px; height:1px;
  background: var(--gold);
  opacity:0.4;
}

.welcome-pills {
  display:flex; flex-wrap:wrap;
  justify-content:center; gap:12px;
  max-width:700px;
}
.welcome-pill {
  font-size:9px; font-weight:600;
  color:var(--text2); letter-spacing:3px;
  text-transform:uppercase;
  padding:8px 16px;
  border:1px solid var(--border2);
}

/* ── LOADING ── */
#loading-screen {
  display:none;
  min-height:72vh;
  flex-direction:column;
  align-items:center; justify-content:center;
  gap:32px; text-align:center;
}

.loading-ticker-display {
  font-family:'Cormorant Garamond', serif;
  font-size:72px; font-weight:300;
  color:var(--gold); letter-spacing:12px;
}

.loading-line {
  width:320px; height:1px;
  background:var(--border2); position:relative; overflow:hidden;
}
.loading-line::after {
  content:'';
  position:absolute; top:0; left:-40%;
  width:40%; height:100%;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  animation:loading-sweep 1.6s ease-in-out infinite;
}
@keyframes loading-sweep { 0%{left:-40%} 100%{left:140%} }

.loading-status {
  font-size:9px; font-weight:500;
  color:var(--text2); letter-spacing:4px;
  text-transform:uppercase;
  font-family:'DM Mono', monospace;
}

/* ── TICKER BAR ── */
.ticker-bar {
  border-top:1px solid var(--border);
  border-bottom:1px solid var(--border);
  padding:20px 0;
  display:flex; align-items:center;
  gap:48px; margin-bottom:40px;
  flex-wrap:wrap;
}

.tb-name {
  font-family:'Cormorant Garamond', serif;
  font-size:36px; font-weight:300;
  color:var(--white); letter-spacing:6px;
  text-transform:uppercase;
}

.tb-company {
  font-size:10px; font-weight:500;
  color:var(--text2); letter-spacing:3px;
  text-transform:uppercase;
  margin-top:4px;
}

.tb-price {
  font-family:'Cormorant Garamond', serif;
  font-size:42px; font-weight:300;
  color:var(--white);
}

.tb-change {
  font-family:'DM Mono', monospace;
  font-size:13px; font-weight:300;
  padding:4px 10px;
  border:1px solid;
}
.tb-change.up   { color:var(--green); border-color:var(--green); background:rgba(76,175,125,0.06); }
.tb-change.down { color:var(--red);   border-color:var(--red);   background:rgba(192,82,74,0.06); }

.tb-meta {
  margin-left:auto;
  display:flex; gap:40px; flex-wrap:wrap;
}
.tb-meta-item { text-align:right; }
.tb-meta-label {
  font-size:8px; font-weight:600;
  color:var(--text3); letter-spacing:3px;
  text-transform:uppercase;
}
.tb-meta-val {
  font-family:'DM Mono', monospace;
  font-size:13px; color:var(--text);
  margin-top:4px;
}

.tb-updated {
  font-size:9px; color:var(--text3);
  font-family:'DM Mono', monospace;
  letter-spacing:1px;
}

/* ── LAYOUT GRIDS ── */
.layout-main {
  display:grid;
  grid-template-columns:1fr 300px;
  gap:24px;
  margin-bottom:24px;
}

.col-right {
  display:flex; flex-direction:column; gap:24px;
}

/* ── CARDS ── */
.card {
  background:var(--card);
  border:1px solid var(--border);
  padding:28px;
  transition:background 0.4s, border-color 0.4s;
}

.card-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:24px;
  padding-bottom:16px;
  border-bottom:1px solid var(--border);
}

.card-title {
  font-size:9px; font-weight:600;
  color:var(--text2); letter-spacing:4px;
  text-transform:uppercase;
}

.card-subtitle {
  font-size:9px; color:var(--text3);
  letter-spacing:2px; text-transform:uppercase;
}

/* ── QUANT SCORE ── */
.score-display {
  display:flex; flex-direction:column;
  align-items:center; gap:20px;
}

.score-ring-wrap {
  position:relative; width:160px; height:90px;
}

.score-ring-wrap svg {
  width:160px; height:96px;
}

.score-number {
  font-family:'Cormorant Garamond', serif;
  font-size:52px; font-weight:300;
  color:var(--gold); text-align:center;
  line-height:1;
}

.score-verdict {
  font-size:9px; font-weight:600;
  letter-spacing:5px; text-transform:uppercase;
  padding:8px 20px;
  border:1px solid;
  text-align:center;
}
.v-strong-buy  { color:var(--green); border-color:var(--green); background:rgba(76,175,125,0.06); }
.v-buy         { color:#6abf8a; border-color:#6abf8a; background:rgba(106,191,138,0.06); }
.v-neutral     { color:var(--gold); border-color:var(--gold); background:rgba(201,168,76,0.06); }
.v-sell        { color:#c0904a; border-color:#c0904a; background:rgba(192,144,74,0.06); }
.v-strong-sell { color:var(--red); border-color:var(--red); background:rgba(192,82,74,0.06); }

.conf-wrap { width:100%; }
.conf-row {
  display:flex; justify-content:space-between;
  font-size:9px; color:var(--text2);
  letter-spacing:2px; text-transform:uppercase;
  margin-bottom:8px;
}
.conf-val { font-family:'DM Mono', monospace; color:var(--gold); }
.conf-track {
  height:2px; background:var(--border2);
}
.conf-fill {
  height:100%;
  background: linear-gradient(90deg, var(--gold), var(--gold2));
  transition:width 1.4s cubic-bezier(0.4,0,0.2,1);
}

/* ── SIGNAL TABLE ── */
.sig-table { width:100%; border-collapse:collapse; }
.sig-table th {
  font-size:8px; font-weight:600;
  color:var(--text3); letter-spacing:3px;
  text-transform:uppercase;
  padding:6px 8px; text-align:left;
  border-bottom:1px solid var(--border);
}
.sig-table td {
  padding:9px 8px;
  border-bottom:1px solid rgba(255,255,255,0.03);
  font-family:'DM Mono', monospace;
  font-size:11px; color:var(--text2);
}
.sig-table tr:hover td { background:rgba(255,255,255,0.02); }
.sig-name { color:var(--text) !important; font-family:'Montserrat',sans-serif !important; font-size:11px !important; font-weight:500 !important; }
.sig-bull { color:var(--green) !important; }
.sig-bear { color:var(--red) !important; }
.sig-neut { color:var(--gold) !important; }

/* ── RISK METRICS ── */
.risk-grid {
  display:grid; grid-template-columns:1fr 1fr;
  gap:16px;
}
.risk-item {
  padding:16px;
  border:1px solid var(--border);
  background:var(--bg3);
}
.risk-lbl {
  font-size:8px; font-weight:600;
  color:var(--text3); letter-spacing:3px;
  text-transform:uppercase; margin-bottom:8px;
}
.risk-val {
  font-family:'Cormorant Garamond', serif;
  font-size:26px; font-weight:300;
  color:var(--gold);
}
.risk-sub {
  font-size:9px; color:var(--text3);
  margin-top:3px; letter-spacing:1px;
}

/* ── FORECAST STATS ── */
.fc-stats {
  display:grid; grid-template-columns:repeat(4,1fr);
  gap:0;
  border:1px solid var(--border);
  margin-bottom:24px;
}
.fc-stat {
  padding:20px;
  text-align:center;
  border-right:1px solid var(--border);
}
.fc-stat:last-child { border-right:none; }
.fc-stat-lbl {
  font-size:8px; font-weight:600;
  color:var(--text3); letter-spacing:3px;
  text-transform:uppercase; margin-bottom:12px;
}
.fc-stat-price {
  font-family:'Cormorant Garamond', serif;
  font-size:28px; font-weight:300;
  color:var(--white);
}
.fc-stat-chg {
  font-family:'DM Mono', monospace;
  font-size:11px; margin-top:4px;
}

/* ── AI CHAT ── */
.chat-wrap {
  background:var(--card);
  border:1px solid var(--border);
  margin-bottom:60px;
}

.chat-top {
  padding:20px 28px;
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:16px;
}

.chat-ai-badge {
  width:36px; height:36px;
  background:var(--gold3);
  border:1px solid rgba(201,168,76,0.3);
  display:flex; align-items:center; justify-content:center;
  font-family:'Cormorant Garamond', serif;
  font-size:16px; color:var(--gold);
}

.chat-ai-label {
  font-size:9px; font-weight:600;
  color:var(--text2); letter-spacing:4px;
  text-transform:uppercase;
}
.chat-ai-sub {
  font-size:9px; color:var(--text3);
  letter-spacing:2px; margin-top:2px;
}

.chat-msgs {
  height:360px; overflow-y:auto;
  padding:28px; display:flex;
  flex-direction:column; gap:20px;
  scroll-behavior:smooth;
}
.chat-msgs::-webkit-scrollbar { width:3px; }
.chat-msgs::-webkit-scrollbar-track { background:transparent; }
.chat-msgs::-webkit-scrollbar-thumb { background:var(--border2); }

.msg { display:flex; gap:12px; animation:msgIn 0.3s ease; }
@keyframes msgIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

.msg.user { flex-direction:row-reverse; }

.msg-av {
  width:30px; height:30px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:10px; font-weight:600; letter-spacing:1px;
  font-family:'Montserrat', sans-serif;
}
.msg.ai .msg-av { background:var(--gold3); border:1px solid rgba(201,168,76,0.3); color:var(--gold); }
.msg.user .msg-av { background:var(--bg3); border:1px solid var(--border2); color:var(--text2); }

.msg-body {
  max-width:80%;
  padding:14px 18px;
  font-size:13px; line-height:1.8;
  color:var(--text);
  font-weight:300;
}
.msg.ai .msg-body   { background:var(--bg3); border:1px solid var(--border); border-left:2px solid var(--gold); }
.msg.user .msg-body { background:var(--bg3); border:1px solid var(--border); border-right:2px solid rgba(201,168,76,0.3); }

.typing-dots { display:flex; gap:4px; align-items:center; padding:4px 0; }
.typing-dot {
  width:5px; height:5px; border-radius:50%;
  background:var(--gold); opacity:0.4;
  animation:typingAnim 1.2s infinite;
}
.typing-dot:nth-child(2) { animation-delay:0.2s; }
.typing-dot:nth-child(3) { animation-delay:0.4s; }
@keyframes typingAnim { 0%,100%{opacity:0.2;transform:scale(1)} 50%{opacity:1;transform:scale(1.3)} }

.chat-bottom {
  display:flex;
  border-top:1px solid var(--border);
}
.chat-input {
  flex:1;
  background:transparent; border:none;
  padding:16px 28px;
  color:var(--text);
  font-family:'Montserrat', sans-serif;
  font-size:13px; font-weight:300;
  outline:none;
}
.chat-input::placeholder { color:var(--text3); }
.btn-send {
  background:transparent; border:none;
  border-left:1px solid var(--border);
  color:var(--gold);
  font-family:'Montserrat', sans-serif;
  font-size:9px; font-weight:600;
  letter-spacing:4px; text-transform:uppercase;
  padding:16px 28px;
  cursor:pointer; transition:all 0.3s;
}
.btn-send:hover { background:var(--gold3); }
.btn-send:disabled { opacity:0.3; cursor:not-allowed; }

/* ── ERROR BANNER ── */
.err-banner {
  display:none;
  background:rgba(192,82,74,0.08);
  border:1px solid rgba(192,82,74,0.3);
  color:var(--red);
  padding:12px 20px;
  font-size:11px; letter-spacing:1px;
  font-family:'DM Mono', monospace;
  margin-bottom:20px;
}

/* ── FOOTER ── */
footer {
  border-top:1px solid var(--border);
  padding:28px 48px;
  display:flex; align-items:center; justify-content:space-between;
  position:relative; z-index:1;
}
.footer-mark {
  font-family:'Cormorant Garamond', serif;
  font-size:15px; font-weight:300;
  color:var(--text3); letter-spacing:4px;
}
.footer-disc {
  font-size:8px; font-weight:500;
  color:var(--text3); letter-spacing:2px;
  text-transform:uppercase; text-align:right;
}

/* ── CHARTS ── */
#priceChart    { height:300px !important; }
#macdChart     { height:130px !important; }
#rsiChart      { height:110px !important; }
#forecastChart { height:260px !important; }

/* ── DASHBOARD hidden initially ── */
#dashboard { display:none; }

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border2); }
</style>
</head>
<body>

<!-- ══════════════════════════════════════════
     PASSWORD SCREEN
══════════════════════════════════════════ -->
<div id="pw-screen">
  <div class="pw-bg"></div>
  <div class="pw-line-top"></div>
  <div class="pw-line-bottom"></div>
  <div class="pw-line-left"></div>
  <div class="pw-line-right"></div>

  <div class="pw-inner">
    <div class="pw-monogram">QE</div>
    <div>
      <div class="pw-wordmark">QuantHedge</div>
      <div class="pw-tagline">Private Investment Terminal</div>
    </div>
    <div class="pw-rule"></div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:16px;">
      <div class="pw-label">Secure Access</div>
      <input type="password" class="pw-input" id="pwInput" placeholder="· · · · · ·" maxlength="12" onkeydown="if(event.key==='Enter')checkPw()">
      <div class="pw-err-msg" id="pwErr"></div>
      <button class="pw-submit" onclick="checkPw()">Enter Terminal</button>
    </div>
  </div>
  <div class="pw-footer-text">Confidential — Authorised Personnel Only</div>
</div>

<!-- ══════════════════════════════════════════
     INTRO SLIDESHOW
══════════════════════════════════════════ -->
<div id="intro-show">
  <div class="ss-bg"></div>
  <div class="ss-corner tl"></div>
  <div class="ss-corner tr"></div>
  <div class="ss-corner bl"></div>
  <div class="ss-corner br"></div>

  <div class="slide active" id="s0">
    <div class="slide-eyebrow">Welcome</div>
    <div class="slide-heading">Your Personal<br><em>Hedge Fund</em><br>Terminal</div>
    <div class="slide-rule"></div>
    <div class="slide-body">Institutional-grade quantitative analysis, previously reserved for the world's most sophisticated investors.</div>
  </div>

  <div class="slide" id="s1">
    <div class="slide-eyebrow">Quantitative Intelligence</div>
    <div class="slide-heading">14 Signals.<br><em>One Score.</em></div>
    <div class="slide-rule"></div>
    <div class="slide-body">Trend, momentum, mean reversion, volume microstructure, and volatility — weighted and distilled into a single, actionable verdict.</div>
    <div class="slide-stats">
      <div class="slide-stat-item"><div class="slide-stat-num">14</div><div class="slide-stat-lbl">Indicators</div></div>
      <div class="slide-stat-item"><div class="slide-stat-num">500</div><div class="slide-stat-lbl">Monte Carlo Paths</div></div>
      <div class="slide-stat-item"><div class="slide-stat-num">30D</div><div class="slide-stat-lbl">Price Forecast</div></div>
    </div>
  </div>

  <div class="slide" id="s2">
    <div class="slide-eyebrow">Risk Architecture</div>
    <div class="slide-heading">Institutional<br><em>Risk Models</em></div>
    <div class="slide-rule"></div>
    <div class="slide-body">Value at Risk, Sharpe estimation, and Geometric Brownian Motion forecasting — the same mathematical foundations used by Goldman Sachs and Citadel.</div>
  </div>

  <div class="slide" id="s3">
    <div class="slide-eyebrow">AI Advisory</div>
    <div class="slide-heading">Your Private<br><em>Quant Analyst</em></div>
    <div class="slide-rule"></div>
    <div class="slide-body">Every analysis concludes with an institutional investment thesis — entry zones, stop-losses, and position sizing, delivered by AI in plain language.</div>
  </div>

  <div class="ss-progress">
    <div class="ss-dot active" id="d0"></div>
    <div class="ss-dot" id="d1"></div>
    <div class="ss-dot" id="d2"></div>
    <div class="ss-dot" id="d3"></div>
  </div>
  <button class="ss-skip" onclick="endShow()">Skip</button>
</div>

<!-- ══════════════════════════════════════════
     MAIN APP
══════════════════════════════════════════ -->
<header>
  <div class="logo-area">
    <div class="logo-mark">QE</div>
    <div class="logo-name">QuantHedge</div>
  </div>
  <div class="header-divider"></div>

  <div class="search-wrap">
    <input type="text" id="tickerInput" placeholder="Enter ticker  —  AAPL · NVDA · TSLA" maxlength="10">
    <button class="btn-analyze" id="analyzeBtn" onclick="startAnalysis()">Analyse</button>
  </div>

  <div class="header-right">
    <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle theme">☽</button>
    <div class="status-text"><span class="status-dot"></span><span id="statusText">Ready</span></div>
  </div>
</header>

<main>
  <div class="err-banner" id="errBanner"></div>

  <!-- WELCOME -->
  <div id="welcome-screen">
    <div class="welcome-headline">Institutional<br><em>Analysis</em></div>
    <div class="welcome-rule"></div>
    <div class="welcome-sub">Renaissance · Citadel · Inspired Methodology</div>
    <div class="welcome-pills">
      <div class="welcome-pill">14 Technical Indicators</div>
      <div class="welcome-pill">Monte Carlo Simulation</div>
      <div class="welcome-pill">Value at Risk</div>
      <div class="welcome-pill">Sharpe Ratio</div>
      <div class="welcome-pill">AI Investment Thesis</div>
      <div class="welcome-pill">30-Day Price Forecast</div>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loading-screen">
    <div class="loading-ticker-display" id="loadingTicker">—</div>
    <div class="loading-line"></div>
    <div class="loading-status" id="loadingStatus">Initialising</div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard">

    <!-- Ticker Bar -->
    <div class="ticker-bar">
      <div>
        <div class="tb-name" id="db-ticker">—</div>
        <div class="tb-company" id="db-company">—</div>
      </div>
      <div class="tb-price" id="db-price">$—</div>
      <div class="tb-change" id="db-change">—</div>
      <div class="tb-meta">
        <div class="tb-meta-item"><div class="tb-meta-label">Volume</div><div class="tb-meta-val" id="db-vol">—</div></div>
        <div class="tb-meta-item"><div class="tb-meta-label">Market Cap</div><div class="tb-meta-val" id="db-mktcap">—</div></div>
        <div class="tb-meta-item"><div class="tb-meta-label">52W High</div><div class="tb-meta-val" id="db-52h">—</div></div>
        <div class="tb-meta-item"><div class="tb-meta-label">52W Low</div><div class="tb-meta-val" id="db-52l">—</div></div>
        <div class="tb-meta-item"><div class="tb-meta-label">P/E</div><div class="tb-meta-val" id="db-pe">—</div></div>
      </div>
      <div class="tb-updated" id="db-updated">—</div>
    </div>

    <!-- Main layout -->
    <div class="layout-main">

      <!-- Left column: charts -->
      <div style="display:flex;flex-direction:column;gap:24px;">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Price Action</span>
            <span class="card-subtitle">SMA 20 · 50 · 200 · Bollinger Bands</span>
          </div>
          <canvas id="priceChart"></canvas>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">MACD</span>
            <span class="card-subtitle">12 · 26 · 9</span>
          </div>
          <canvas id="macdChart"></canvas>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">RSI</span>
            <span class="card-subtitle">Relative Strength · 14 Periods</span>
          </div>
          <canvas id="rsiChart"></canvas>
        </div>
      </div>

      <!-- Right column -->
      <div class="col-right">

        <!-- Score -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Quant Score</span>
          </div>
          <div class="score-display">
            <svg width="160" height="96" viewBox="0 0 160 96">
              <path d="M 16 88 A 68 68 0 0 1 144 88" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="10" stroke-linecap="round"/>
              <path id="scoreArc" d="M 16 88 A 68 68 0 0 1 144 88" fill="none" stroke="#c9a84c" stroke-width="10" stroke-linecap="round" stroke-dasharray="213.6" stroke-dashoffset="213.6" style="transition:stroke-dashoffset 1.4s cubic-bezier(0.4,0,0.2,1)"/>
            </svg>
            <div class="score-number" id="scoreNum">—</div>
            <div class="score-verdict" id="scoreVerdict">—</div>
            <div class="conf-wrap">
              <div class="conf-row">
                <span>Signal Confidence</span>
                <span class="conf-val" id="confVal">—</span>
              </div>
              <div class="conf-track">
                <div class="conf-fill" id="confFill" style="width:0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Signals -->
        <div class="card" style="flex:1;overflow:auto;">
          <div class="card-header"><span class="card-title">Signal Breakdown</span></div>
          <table class="sig-table">
            <thead>
              <tr><th>Indicator</th><th>Value</th><th>Signal</th></tr>
            </thead>
            <tbody id="sigBody"></tbody>
          </table>
        </div>

        <!-- Risk -->
        <div class="card">
          <div class="card-header"><span class="card-title">Risk Metrics</span></div>
          <div class="risk-grid">
            <div class="risk-item"><div class="risk-lbl">Volatility</div><div class="risk-val" id="rm-vol">—</div><div class="risk-sub">20D annualised</div></div>
            <div class="risk-item"><div class="risk-lbl">VaR 95%</div><div class="risk-val" id="rm-var">—</div><div class="risk-sub">Daily estimate</div></div>
            <div class="risk-item"><div class="risk-lbl">ATR (14)</div><div class="risk-val" id="rm-atr">—</div><div class="risk-sub">Avg true range</div></div>
            <div class="risk-item"><div class="risk-lbl">Sharpe</div><div class="risk-val" id="rm-sharpe">—</div><div class="risk-sub">252D rolling</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Monte Carlo -->
    <div class="card" style="margin-bottom:24px;">
      <div class="card-header">
        <span class="card-title">Monte Carlo Forecast</span>
        <span class="card-subtitle">500 Simulation Paths · 30 Day Horizon · GBM</span>
      </div>
      <div class="fc-stats" id="fcStats">
        <div class="fc-stat"><div class="fc-stat-lbl">Current</div><div class="fc-stat-price" id="fc-curr">—</div></div>
        <div class="fc-stat"><div class="fc-stat-lbl">Median (30D)</div><div class="fc-stat-price" id="fc-med">—</div><div class="fc-stat-chg" id="fc-medchg">—</div></div>
        <div class="fc-stat"><div class="fc-stat-lbl">Bull Case · 75th %ile</div><div class="fc-stat-price" id="fc-bull" style="color:var(--green)">—</div><div class="fc-stat-chg" id="fc-bullchg" style="color:var(--green)">—</div></div>
        <div class="fc-stat"><div class="fc-stat-lbl">Bear Case · 25th %ile</div><div class="fc-stat-price" id="fc-bear" style="color:var(--red)">—</div><div class="fc-stat-chg" id="fc-bearchg" style="color:var(--red)">—</div></div>
      </div>
      <canvas id="forecastChart"></canvas>
    </div>

    <!-- AI Chat -->
    <div class="chat-wrap">
      <div class="chat-top">
        <div class="chat-ai-badge">AI</div>
        <div>
          <div class="chat-ai-label">Quant AI Analyst</div>
          <div class="chat-ai-sub" id="chatStatus">Powered by LLaMA 3.3 · 70B via Groq</div>
        </div>
      </div>
      <div class="chat-msgs" id="chatMsgs">
        <div class="msg ai">
          <div class="msg-av">AI</div>
          <div class="msg-body">Good morning. I am your private quantitative analyst. Run an analysis to receive an institutional-grade investment thesis with specific entry zones, risk parameters, and position sizing recommendations.</div>
        </div>
      </div>
      <div class="chat-bottom">
        <input class="chat-input" id="chatInput" placeholder="Ask a follow-up question…" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn-send" id="sendBtn" onclick="sendChat()">Send</button>
      </div>
    </div>

  </div><!-- end dashboard -->
</main>

<footer>
  <div class="footer-mark">QuantHedge</div>
  <div class="footer-disc">For educational purposes only · Not financial advice<br>Past performance does not guarantee future results</div>
</footer>

<script>

// ── PASSWORD ──
const CORRECT_PASSWORD = '260558';
function checkPw() {
  const inp = document.getElementById('pwInput');
  if (inp.value.trim() === CORRECT_PASSWORD) {
    const scr = document.getElementById('pw-screen');
    scr.style.transition = 'opacity 0.7s ease';
    scr.style.opacity = '0';
    setTimeout(() => { scr.style.display = 'none'; startShow(); }, 700);
  } else {
    inp.classList.add('pw-error');
    document.getElementById('pwErr').textContent = 'Invalid access code';
    setTimeout(() => { inp.classList.remove('pw-error'); inp.value = ''; document.getElementById('pwErr').textContent = ''; }, 1800);
  }
}
document.getElementById('pwInput').focus();

// ── SLIDESHOW ──
let slideIdx = 0;
const slideCount = 4;
let slideTimer = null;

function startShow() {
  document.getElementById('intro-show').style.display = 'block';
  showSlide(0);
  slideTimer = setInterval(() => {
    slideIdx++;
    if (slideIdx >= slideCount) { endShow(); return; }
    showSlide(slideIdx);
  }, 2800);
}

function showSlide(i) {
  document.querySelectorAll('.slide').forEach((s,idx) => s.classList.toggle('active', idx === i));
  document.querySelectorAll('.ss-dot').forEach((d,idx) => d.classList.toggle('active', idx === i));
}

function endShow() {
  clearInterval(slideTimer);
  const ss = document.getElementById('intro-show');
  ss.style.transition = 'opacity 0.7s ease';
  ss.style.opacity = '0';
  setTimeout(() => { ss.style.display = 'none'; ss.style.opacity = '1'; }, 700);
}

// ── THEME ──
let isDark = true;
function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle('light', !isDark);
  document.getElementById('themeBtn').textContent = isDark ? '☽' : '○';
  if (currentAnalysis) {
    const {prices, volumes, dates, indicators, forecast} = currentAnalysis;
    renderPriceChart(dates, prices.close, indicators);
    renderMacdChart(dates, indicators);
    renderRsiChart(dates, indicators);
    renderForecastChart(prices.close, forecast, dates);
  }
}


const GROQ_API_KEY = "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";

// ── STATE ──
let priceChart, macdChart, rsiChart, forecastChart;
let chatHistory = [];
let currentAnalysis = null;

// ── ENTRY ──
document.getElementById('tickerInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') startAnalysis();
});

async function startAnalysis() {
  const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
  if (!ticker) return;

  hideError();
  showLoading(ticker);
  setStatus('FETCHING DATA...');
  document.getElementById('analyzeBtn').disabled = true;

  try {
    setStep(1);
    const { prices, volumes, dates, meta } = await fetchData(ticker);

    setStep(2);
    const indicators = computeIndicators(prices, volumes);

    setStep(3);
    const forecast = runMonteCarlo(prices);

    setStep(4);
    const { score, verdict, signals } = computeQuantScore(indicators, prices);

    setStep(5);
    showDashboard(ticker, prices, volumes, dates, meta, indicators, forecast, score, verdict, signals);

    currentAnalysis = { ticker, prices, volumes, dates, meta, indicators, forecast, score, verdict, signals };
    chatHistory = [];

    await autoConsult(ticker, score, verdict, signals, indicators, forecast, meta);

  } catch (err) {
    showError('Error: ' + err.message);
    showWelcome();
  }

  setStatus('SYSTEM READY');
  document.getElementById('analyzeBtn').disabled = false;
}

// ── DATA FETCH ──
async function fetchData(ticker) {
  const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1y&includePrePost=false`;
  const yahooUrl2 = `https://query2.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1y`;

  const attempts = [
    { url: `https://corsproxy.io/?url=${encodeURIComponent(yahooUrl)}`, wrap: false },
    { url: `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`, wrap: true },
    { url: `https://corsproxy.io/?url=${encodeURIComponent(yahooUrl2)}`, wrap: false },
    { url: `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl2)}`, wrap: true },
    { url: `https://thingproxy.freeboard.io/fetch/${yahooUrl}`, wrap: false },
    { url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(yahooUrl)}`, wrap: false },
    { url: yahooUrl, wrap: false },
  ];

  let json = null;
  let lastErr = '';

  for (const attempt of attempts) {
    try {
      const res = await fetch(attempt.url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) { lastErr = `HTTP ${res.status} from ${attempt.url}`; continue; }
      const raw = await res.json();
      json = attempt.wrap && raw.contents ? JSON.parse(raw.contents) : raw;
      if (json?.chart?.result?.[0]?.timestamp?.length > 10) break;
      json = null;
    } catch(e) { lastErr = e.message; continue; }
  }

  if (!json?.chart?.result?.[0]) throw new Error(`Daten konnten nicht geladen werden für '${ticker}'. Bitte stelle sicher dass du mit dem Internet verbunden bist. (${lastErr})`);

  const result = json.chart?.result?.[0];
  if (!result) throw new Error(`No data returned for ${ticker}`);

  const timestamps = result.timestamp;
  const q = result.indicators.quote[0];
  const closes = q.close;
  const volumes = q.volume;
  const highs = q.high;
  const lows = q.low;

  // Filter out null values
  const valid = timestamps.map((t,i) => ({
    date: new Date(t * 1000),
    close: closes[i],
    volume: volumes[i],
    high: highs[i],
    low: lows[i]
  })).filter(d => d.close != null && d.volume != null);

  const prices = { close: valid.map(d=>d.close), high: valid.map(d=>d.high), low: valid.map(d=>d.low) };
  const vols = valid.map(d => d.volume);
  const dates = valid.map(d => d.date.toLocaleDateString('en-US', {month:'short',day:'numeric'}));

  // Get meta
  const m = result.meta;
  const meta = {
    ticker,
    name: m.shortName || m.symbol || ticker,
    price: m.regularMarketPrice || valid[valid.length-1].close,
    prevClose: m.previousClose || m.chartPreviousClose,
    volume: m.regularMarketVolume,
    mktCap: null,
    high52: m.fiftyTwoWeekHigh,
    low52: m.fiftyTwoWeekLow,
    pe: null,
    exchange: m.exchangeName || ''
  };

  return { prices, volumes: vols, dates, meta };
}

// ── INDICATORS ──
function computeIndicators(prices, volumes) {
  const c = prices.close;
  const h = prices.high;
  const l = prices.low;
  const n = c.length;

  function sma(arr, p) {
    return arr.map((_, i) => i < p-1 ? null : avg(arr.slice(i-p+1, i+1)));
  }

  function ema(arr, p) {
    const k = 2/(p+1);
    const res = new Array(arr.length).fill(null);
    let start = arr.findIndex(v => v != null);
    res[start + p - 1] = avg(arr.slice(start, start+p));
    for (let i = start+p; i < arr.length; i++) {
      res[i] = arr[i] * k + res[i-1] * (1-k);
    }
    return res;
  }

  function avg(arr) { return arr.reduce((a,b)=>a+b,0)/arr.length; }
  function std(arr) {
    const m = avg(arr);
    return Math.sqrt(arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length);
  }

  const sma20 = sma(c, 20);
  const sma50 = sma(c, 50);
  const sma200 = sma(c, 200);
  const ema12 = ema(c, 12);
  const ema26 = ema(c, 26);

  // MACD
  const macdLine = ema12.map((v,i) => v != null && ema26[i] != null ? v - ema26[i] : null);
  const macdSignal = ema(macdLine.map(v => v ?? 0), 9).map((v,i) => macdLine[i] != null ? v : null);
  const macdHist = macdLine.map((v,i) => v != null && macdSignal[i] != null ? v - macdSignal[i] : null);

  // RSI
  const rsi = new Array(n).fill(null);
  if (n > 15) {
    let gains = 0, losses = 0;
    for (let i = 1; i <= 14; i++) {
      const d = c[i] - c[i-1];
      if (d > 0) gains += d; else losses -= d;
    }
    let avgG = gains/14, avgL = losses/14;
    rsi[14] = avgL === 0 ? 100 : 100 - 100/(1 + avgG/avgL);
    for (let i = 15; i < n; i++) {
      const d = c[i] - c[i-1];
      avgG = (avgG * 13 + (d > 0 ? d : 0)) / 14;
      avgL = (avgL * 13 + (d < 0 ? -d : 0)) / 14;
      rsi[i] = avgL === 0 ? 100 : 100 - 100/(1 + avgG/avgL);
    }
  }

  // Bollinger Bands
  const bbUpper = [], bbLower = [], bbMid = [];
  for (let i = 0; i < n; i++) {
    if (i < 19) { bbUpper.push(null); bbLower.push(null); bbMid.push(null); continue; }
    const slice = c.slice(i-19, i+1);
    const m = avg(slice);
    const s = std(slice);
    bbMid.push(m);
    bbUpper.push(m + 2*s);
    bbLower.push(m - 2*s);
  }

  // Z-score
  const zScore = c.map((v,i) => {
    if (i < 19) return null;
    const slice = c.slice(i-19, i+1);
    const m = avg(slice);
    const s = std(slice);
    return s > 0 ? (v - m)/s : 0;
  });

  // OBV
  const obv = [0];
  for (let i = 1; i < n; i++) {
    if (c[i] > c[i-1]) obv.push(obv[i-1] + volumes[i]);
    else if (c[i] < c[i-1]) obv.push(obv[i-1] - volumes[i]);
    else obv.push(obv[i-1]);
  }

  // Volume Z-score
  const volZ = volumes.map((v,i) => {
    if (i < 19) return 0;
    const slice = volumes.slice(i-19, i+1);
    const m = avg(slice);
    const s = std(slice);
    return s > 0 ? (v - m)/s : 0;
  });

  // ATR
  const atr14 = [];
  const tr = [0];
  for (let i = 1; i < n; i++) {
    tr.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
  }
  for (let i = 0; i < n; i++) {
    if (i < 14) { atr14.push(null); continue; }
    atr14.push(avg(tr.slice(i-13, i+1)));
  }

  // Historical Volatility (20-day annualized)
  const returns = c.map((v,i) => i === 0 ? 0 : Math.log(v/c[i-1]));
  const vol20 = returns.map((_, i) => {
    if (i < 20) return null;
    const r = returns.slice(i-19, i+1);
    return std(r) * Math.sqrt(252) * 100;
  });

  // CMF
  const cmf = [];
  for (let i = 0; i < n; i++) {
    if (i < 19) { cmf.push(null); continue; }
    let mfv = 0, vol = 0;
    for (let j = i-19; j <= i; j++) {
      const hl = h[j] - l[j];
      const mfm = hl > 0 ? ((c[j]-l[j]) - (h[j]-c[j]))/hl : 0;
      mfv += mfm * volumes[j];
      vol += volumes[j];
    }
    cmf.push(vol > 0 ? mfv/vol : 0);
  }

  // ROC
  const roc10 = c.map((v,i) => i < 10 ? null : (v/c[i-10] - 1)*100);

  // ADX
  const adx = computeADX(h, l, c, 14);

  const last = n - 1;
  return {
    sma20, sma50, sma200, ema12, ema26,
    macdLine, macdSignal, macdHist,
    rsi, bbUpper, bbLower, bbMid,
    zScore, obv, volZ, atr14, vol20,
    cmf, roc10, adx,
    current: {
      price: c[last],
      sma20: sma20[last], sma50: sma50[last], sma200: sma200[last],
      rsi: rsi[last], macd: macdLine[last], macdSig: macdSignal[last],
      macdHist: macdHist[last],
      bbU: bbUpper[last], bbL: bbLower[last], bbM: bbMid[last],
      zScore: zScore[last], obv: obv[last], obvPrev: obv[last-5],
      volZ: volZ[last], atr: atr14[last],
      vol20: vol20[last], cmf: cmf[last],
      roc10: roc10[last], adx: adx[last],
      high52: Math.max(...c.slice(-252)),
      low52: Math.min(...c.slice(-252)),
    },
    n, returns, close: c
  };
}

function computeADX(h, l, c, p) {
  const n = c.length;
  const adx = new Array(n).fill(null);
  if (n < p * 2) return adx;

  const trArr = [0], pdm = [0], ndm = [0];
  for (let i = 1; i < n; i++) {
    trArr.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
    pdm.push(h[i]-h[i-1] > l[i-1]-l[i] && h[i]-h[i-1] > 0 ? h[i]-h[i-1] : 0);
    ndm.push(l[i-1]-l[i] > h[i]-h[i-1] && l[i-1]-l[i] > 0 ? l[i-1]-l[i] : 0);
  }

  let atr = trArr.slice(1, p+1).reduce((a,b)=>a+b,0);
  let pDI = pdm.slice(1, p+1).reduce((a,b)=>a+b,0);
  let nDI = ndm.slice(1, p+1).reduce((a,b)=>a+b,0);

  const dxArr = [];
  for (let i = p; i < n; i++) {
    if (i > p) {
      atr = atr - atr/p + trArr[i];
      pDI = pDI - pDI/p + pdm[i];
      nDI = nDI - nDI/p + ndm[i];
    }
    const pdi = atr > 0 ? 100*pDI/atr : 0;
    const ndi = atr > 0 ? 100*nDI/atr : 0;
    const dx = (pdi+ndi) > 0 ? 100*Math.abs(pdi-ndi)/(pdi+ndi) : 0;
    dxArr.push(dx);
    if (dxArr.length >= p) {
      adx[i] = dxArr.slice(-p).reduce((a,b)=>a+b,0)/p;
    }
  }
  return adx;
}

// ── QUANT SCORE ──
function computeQuantScore(ind, prices) {
  const c = ind.current;
  const signals = [];
  let bullScore = 0, totalWeight = 0;

  function addSignal(name, value, signal, weight, note) {
    const s = signal === 'bull' ? 1 : signal === 'bear' ? -1 : 0;
    bullScore += s * weight;
    totalWeight += weight;
    signals.push({ name, value, signal, weight, note });
  }

  // Trend signals (35% total)
  addSignal('Price vs SMA20', c.price > c.sma20 ? '+' + ((c.price/c.sma20-1)*100).toFixed(1)+'%' : ((c.price/c.sma20-1)*100).toFixed(1)+'%', c.price > c.sma20 ? 'bull' : 'bear', 7, 'Price above SMA20 is bullish');
  addSignal('Price vs SMA50', c.price > c.sma50 ? '+' + ((c.price/c.sma50-1)*100).toFixed(1)+'%' : ((c.price/c.sma50-1)*100).toFixed(1)+'%', c.price > c.sma50 ? 'bull' : 'bear', 7, '');
  addSignal('Price vs SMA200', c.price > c.sma200 ? '+' + ((c.price/c.sma200-1)*100).toFixed(1)+'%' : ((c.price/c.sma200-1)*100).toFixed(1)+'%', c.price > c.sma200 ? 'bull' : 'bear', 8, 'Golden/Death cross indicator');
  addSignal('MACD Cross', c.macdHist > 0 ? 'Positive' : 'Negative', c.macdHist > 0 ? 'bull' : 'bear', 8, 'MACD histogram: ' + (c.macdHist || 0).toFixed(2));
  addSignal('ROC (10d)', c.roc10 != null ? c.roc10.toFixed(1)+'%' : 'N/A', c.roc10 > 0 ? 'bull' : c.roc10 < 0 ? 'bear' : 'neutral', 5, '10-day rate of change');

  // Mean reversion (25% total)
  const bbPos = c.bbU && c.bbL ? (c.price - c.bbL)/(c.bbU - c.bbL) : 0.5;
  addSignal('Bollinger Pos', (bbPos*100).toFixed(0)+'%', bbPos < 0.2 ? 'bull' : bbPos > 0.8 ? 'bear' : 'neutral', 8, 'Position within BB');
  addSignal('Z-Score', c.zScore != null ? c.zScore.toFixed(2) : 'N/A', c.zScore < -1.5 ? 'bull' : c.zScore > 1.5 ? 'bear' : 'neutral', 9, 'Price deviation from 20d mean');
  const distFrom52H = ((c.high52 - c.price)/c.high52*100).toFixed(1);
  addSignal('52W Reversion', distFrom52H+'% from high', parseFloat(distFrom52H) > 20 ? 'bull' : parseFloat(distFrom52H) < 5 ? 'bear' : 'neutral', 8, '');

  // Volume (20% total)
  addSignal('OBV Trend', c.obv > c.obvPrev ? 'Rising' : 'Falling', c.obv > c.obvPrev ? 'bull' : 'bear', 7, 'On-balance volume');
  addSignal('Volume Spike', c.volZ > 2 ? 'High ('+c.volZ.toFixed(1)+'σ)' : 'Normal', c.volZ > 2 && c.price > ind.sma20[ind.n-1] ? 'bull' : c.volZ > 2 ? 'bear' : 'neutral', 6, 'Volume z-score');
  addSignal('CMF (20d)', c.cmf != null ? c.cmf.toFixed(3) : 'N/A', c.cmf > 0.05 ? 'bull' : c.cmf < -0.05 ? 'bear' : 'neutral', 7, 'Chaikin Money Flow');

  // Volatility/Risk (20% total)
  addSignal('RSI (14)', c.rsi != null ? c.rsi.toFixed(1) : 'N/A', c.rsi < 35 ? 'bull' : c.rsi > 65 ? 'bear' : 'neutral', 8, 'Oversold <35, Overbought >65');
  addSignal('ADX Strength', c.adx != null ? c.adx.toFixed(1) : 'N/A', c.adx > 25 ? 'bull' : 'neutral', 5, 'Trend strength >25 = strong');
  addSignal('Volatility', c.vol20 != null ? c.vol20.toFixed(1)+'%' : 'N/A', c.vol20 < 20 ? 'bull' : c.vol20 > 50 ? 'bear' : 'neutral', 7, 'Lower vol = stable trend');

  // Normalize to 0-100
  const rawScore = (bullScore / totalWeight + 1) / 2 * 100;
  const score = Math.max(0, Math.min(100, Math.round(rawScore)));

  let verdict;
  if (score >= 80) verdict = 'STRONG BUY';
  else if (score >= 60) verdict = 'BUY';
  else if (score >= 40) verdict = 'NEUTRAL';
  else if (score >= 20) verdict = 'SELL';
  else verdict = 'STRONG SELL';

  // Sharpe
  const r = ind.returns.slice(-252).filter(v => v !== 0);
  const meanR = r.reduce((a,b)=>a+b,0)/r.length;
  const stdR = Math.sqrt(r.reduce((a,b)=>a+(b-meanR)**2,0)/r.length);
  const sharpe = stdR > 0 ? ((meanR * 252 - 0.045) / (stdR * Math.sqrt(252))).toFixed(2) : 'N/A';

  return { score, verdict, signals, sharpe };
}

// ── MONTE CARLO ──
function runMonteCarlo(prices) {
  const c = prices.close;
  const n = c.length;
  const returns = [];
  for (let i = 1; i < n; i++) returns.push(Math.log(c[i]/c[i-1]));

  const mu = returns.reduce((a,b)=>a+b,0)/returns.length;
  const variance = returns.reduce((a,b)=>a+(b-mu)**2,0)/returns.length;
  const sigma = Math.sqrt(variance);
  const drift = mu - variance/2;
  const S0 = c[n-1];
  const steps = 30;
  const paths = 500;

  function randn() {
    let u=0,v=0;
    while(u===0) u=Math.random();
    while(v===0) v=Math.random();
    return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  }

  const allPaths = [];
  for (let p = 0; p < paths; p++) {
    const path = [S0];
    for (let t = 1; t <= steps; t++) {
      path.push(path[t-1] * Math.exp(drift + sigma * randn()));
    }
    allPaths.push(path);
  }

  // Percentiles at each step
  const percentiles = [];
  for (let t = 0; t <= steps; t++) {
    const vals = allPaths.map(p => p[t]).sort((a,b)=>a-b);
    percentiles.push({
      p5: vals[Math.floor(paths*0.05)],
      p25: vals[Math.floor(paths*0.25)],
      p50: vals[Math.floor(paths*0.50)],
      p75: vals[Math.floor(paths*0.75)],
      p95: vals[Math.floor(paths*0.95)],
    });
  }

  // Linear regression on last 90 days
  const histN = Math.min(90, n);
  const histClose = c.slice(n-histN);
  const xs = Array.from({length: histN}, (_,i) => i);
  const xMean = (histN-1)/2;
  const yMean = histClose.reduce((a,b)=>a+b,0)/histN;
  let num=0, den=0;
  xs.forEach((x,i) => { num += (x-xMean)*(histClose[i]-yMean); den += (x-xMean)**2; });
  const slope = den > 0 ? num/den : 0;
  const intercept = yMean - slope * xMean;
  const residuals = histClose.map((v,i) => v - (slope*i + intercept));
  const regStd = Math.sqrt(residuals.reduce((a,b)=>a+b**2,0)/histN);

  const regFwd = Array.from({length: steps+1}, (_,i) => {
    const x = histN - 1 + i;
    return slope * x + intercept;
  });

  return { allPaths, percentiles, regFwd, regStd, S0, steps, sigma, mu };
}

// ── SHOW DASHBOARD ──
function showDashboard(ticker, prices, volumes, dates, meta, ind, forecast, score, verdict, signals) {
  showWelcome(false);
   document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';

  // Ticker Bar
  document.getElementById('db-ticker').textContent = ticker;
  document.getElementById('db-company').textContent = meta.name;
  const price = meta.price;
  const change = price - meta.prevClose;
  const changePct = (change/meta.prevClose*100);
  document.getElementById('db-price').textContent = '$' + price.toFixed(2);
  const chEl = document.getElementById('db-change');
  chEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + ' (' + (changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%)';
  chEl.className = 'ticker-change ' + (change >= 0 ? 'up' : 'down');
  document.getElementById('db-vol').textContent = fmtNum(meta.volume || volumes[volumes.length-1]);
  document.getElementById('db-mktcap').textContent = meta.mktCap ? '$' + fmtBig(meta.mktCap) : 'N/A';
  document.getElementById('db-52h').textContent = '$' + (meta.high52 || ind.current.high52).toFixed(2);
  document.getElementById('db-52l').textContent = '$' + (meta.low52 || ind.current.low52).toFixed(2);
  document.getElementById('db-pe').textContent = meta.pe || 'N/A';
  document.getElementById('db-updated').textContent = '↻ ' + new Date().toLocaleTimeString();

  // Risk Metrics
  document.getElementById('rm-vol').textContent = ind.current.vol20 != null ? ind.current.vol20.toFixed(1) + '%' : 'N/A';
  const varDaily = price * (ind.current.vol20/100) / Math.sqrt(252) * 1.645;
  document.getElementById('rm-var').textContent = varDaily > 0 ? '$' + varDaily.toFixed(2) : 'N/A';
  document.getElementById('rm-atr').textContent = ind.current.atr != null ? '$' + ind.current.atr.toFixed(2) : 'N/A';
  
  const r = ind.returns.slice(-252).filter(v => v !== 0);
  const meanR = r.reduce((a,b)=>a+b,0)/r.length;
  const stdR = Math.sqrt(r.reduce((a,b)=>a+(b-meanR)**2,0)/r.length);
  const sharpe = stdR > 0 ? ((meanR * 252 - 0.045) / (stdR * Math.sqrt(252))).toFixed(2) : 'N/A';
  document.getElementById('rm-sharpe').textContent = sharpe;

  // Score gauge
  setTimeout(() => animateGauge(score, verdict), 300);

  // Signal table
  renderSignalTable(signals);

  // Charts
  renderPriceChart(dates, prices.close, ind);
  renderMacdChart(dates, ind);
  renderRsiChart(dates, ind);
  renderForecastChart(prices.close, forecast, dates);

  // Forecast stats
  const fc = forecast.percentiles[forecast.steps];
  const S0 = forecast.S0;
  document.getElementById('fc-curr').textContent = '$' + S0.toFixed(2);
  document.getElementById('fc-med').textContent = '$' + fc.p50.toFixed(2);
  document.getElementById('fc-medchg').textContent = fmtChg(fc.p50, S0);
  document.getElementById('fc-bull').textContent = '$' + fc.p75.toFixed(2);
  document.getElementById('fc-bullchg').textContent = fmtChg(fc.p75, S0);
  document.getElementById('fc-bear').textContent = '$' + fc.p25.toFixed(2);
  document.getElementById('fc-bearchg').textContent = fmtChg(fc.p25, S0);
}

function fmtChg(v, base) {
  const p = (v/base-1)*100;
  return (p >= 0 ? '+' : '') + p.toFixed(1) + '%';
}

function fmtNum(n) {
  if (!n) return 'N/A';
  if (n > 1e9) return (n/1e9).toFixed(1)+'B';
  if (n > 1e6) return (n/1e6).toFixed(1)+'M';
  if (n > 1e3) return (n/1e3).toFixed(1)+'K';
  return n.toString();
}

function fmtBig(n) {
  if (n > 1e12) return (n/1e12).toFixed(2)+'T';
  if (n > 1e9) return (n/1e9).toFixed(2)+'B';
  if (n > 1e6) return (n/1e6).toFixed(2)+'M';
  return n.toString();
}

// ── GAUGE ──
function animateGauge(score, verdict) {
  const fill = document.getElementById('scoreArc');
  const text = document.getElementById('scoreNum');
  const verdictEl = document.getElementById('scoreVerdict');
  const confFill =  document.getElementById('confFill');
  const confVal = document.getElementById('confVal');

  const circumference = 213.6;
  const offset = circumference - (score/100) * circumference;
  
  const color = score >= 80 ? '#00ff88' : score >= 60 ? '#66ff99' : score >= 40 ? '#ffd700' : score >= 20 ? '#ff9500' : '#ff4466';
  
  fill.style.transition = 'stroke-dashoffset 1.5s cubic-bezier(0.4,0,0.2,1)';
  fill.style.stroke = color;
  fill.style.strokeDashoffset = offset;
  text.textContent = score;
  text.style.fill = color;

  function verdictClass(v) {
    const m = {'STRONG BUY':'v-strong-buy','BUY':'v-buy','NEUTRAL':'v-neutral','SELL':'v-sell','STRONG SELL':'v-strong-sell'};
    return m[v] || '';
  }
  const classes = {'STRONG BUY':'v-strong-buy','BUY':'v-buy','NEUTRAL':'v-neutral','SELL':'v-sell','STRONG SELL':'v-strong-sell'};
  verdictEl.textContent = verdict;
  verdictEl.className = 'score-verdict ' + (verdictClass(verdict));

  setTimeout(() => {
    confFill.style.width = score + '%';
    confVal.textContent = score + '%';
  }, 200);
}

// ── SIGNAL TABLE ──
function renderSignalTable(signals) {
  const tbody =  document.getElementById('sigBody');
  tbody.innerHTML = signals.map(s => {
    const dotClass = s.signal === 'bull' ? 'dot-bull' : s.signal === 'bear' ? 'dot-bear' : 'dot-neut';
    const sigClass = s.signal === 'bull' ? 'sig-bull' : s.signal === 'bear' ? 'sig-bear' : 'sig-neut';
    const sigText = s.signal === 'bull' ? '▲ BULL' : s.signal === 'bear' ? '▼ BEAR' : '◆ NEUTRAL';
    return `<tr>
      <td class="sig-indicator">${s.name}</td>
      <td style="color:var(--text2)">${s.value}</td>
      <td class="${sigClass}"><span class="sig-dot ${dotClass}"></span>${sigText}</td>
    </tr>`;
  }).join('');
}

// ── CHARTS ──
function destroyChart(ref) { if (ref) { try { ref.destroy(); } catch(e){} } }

function renderPriceChart(dates, closes, ind) {
  destroyChart(priceChart);
  const ctx = document.getElementById('priceChart').getContext('2d');
  const n = closes.length;
  
  // Buy/sell markers from MACD crossovers
  const buyPoints = [], sellPoints = [];
  for (let i = 1; i < n; i++) {
    if (ind.macdHist[i] > 0 && ind.macdHist[i-1] <= 0 && ind.rsi[i] < 60)
      buyPoints.push({x: dates[i], y: closes[i]});
    if (ind.macdHist[i] < 0 && ind.macdHist[i-1] >= 0 && ind.rsi[i] > 40)
      sellPoints.push({x: dates[i], y: closes[i]});
  }

  priceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'BB Upper', data: ind.bbUpper, borderColor: 'rgba(160,168,184,0.12)',
          borderWidth: 1, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(160,168,184,0.03)', tension: 0.3
        },
        {
          label: 'BB Lower', data: ind.bbLower, borderColor: 'rgba(160,168,184,0.12)',
          borderWidth: 1, pointRadius: 0, fill: false, tension: 0.3
        },
        {
          label: 'Price', data: closes, borderColor: 'rgba(160,168,184,0.9)', borderWidth: 2,
          pointRadius: 0, fill: false, tension: 0.1
        },
        {
          label: 'SMA20', data: ind.sma20, borderColor: 'rgba(201,168,76,0.7)',
          borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3, borderDash: []
        },
        {
          label: 'SMA50', data: ind.sma50, borderColor: 'rgba(160,130,80,0.7)',
          borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3
        },
        {
          label: 'SMA200', data: ind.sma200, borderColor: 'rgba(192,82,74,0.8)',
          borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3
        },
        {
          label: 'BUY', data: buyPoints, type: 'scatter',
          pointStyle: 'triangle', pointRadius: 8, backgroundColor: 'rgba(76,175,125,0.9)', borderColor: 'rgba(76,175,125,0.8)'
        },
        {
          label: 'SELL', data: sellPoints, type: 'scatter',
          pointStyle: 'triangle', rotation: 180, pointRadius: 8, backgroundColor: 'rgba(192,82,74,0.9)', borderColor: 'rgba(192,82,74,0.8)'
        }
      ]
    },
    options: chartOptions('Price & Indicators', true)
  });
}

function renderMacdChart(dates, ind) {
  destroyChart(macdChart);
  const ctx = document.getElementById('macdChart').getContext('2d');
  macdChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'Histogram', data: ind.macdHist, type: 'bar',
          backgroundColor: ind.macdHist.map(v => v > 0 ? 'rgba(76,175,125,0.4)' : 'rgba(192,82,74,0.4)'),
          borderColor: ind.macdHist.map(v => v > 0 ? '#00ff88' : '#ff4466'),
          borderWidth: 1
        },
        {
          label: 'MACD', data: ind.macdLine, type: 'line',
          borderColor: 'rgba(160,168,184,0.9)', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3
        },
        {
          label: 'Signal', data: ind.macdSignal, type: 'line',
          borderColor: 'rgba(160,130,80,0.7)', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3
        }
      ]
    },
    options: chartOptions('MACD', false)
  });
}

function renderRsiChart(dates, ind) {
  destroyChart(rsiChart);
  const ctx = document.getElementById('rsiChart').getContext('2d');
  rsiChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'RSI', data: ind.rsi, borderColor: 'rgba(130,140,180,0.8)',
          borderWidth: 2, pointRadius: 0, fill: false, tension: 0.3
        },
        {
          label: 'OB', data: new Array(dates.length).fill(70),
          borderColor: 'rgba(192,82,74,0.35)', borderWidth: 1, pointRadius: 0,
          fill: false, borderDash: [5,5]
        },
        {
          label: 'OS', data: new Array(dates.length).fill(30),
          borderColor: 'rgba(0,255,136,0.4)', borderWidth: 1, pointRadius: 0,
          fill: false, borderDash: [5,5]
        }
      ]
    },
    options: { ...chartOptions('RSI', false), scales: { ...chartOptions('RSI',false).scales, y: { ...chartOptions('RSI',false).scales.y, min: 0, max: 100 } } }
  });
}

function renderForecastChart(closes, forecast, dates) {
  destroyChart(forecastChart);
  const ctx = document.getElementById('forecastChart').getContext('2d');
  const histN = 30;
  const histClose = closes.slice(-histN);
  const histDates = dates.slice(-histN);

  // Forward dates (approximate)
  const lastDate = new Date();
  const fwdDates = Array.from({length: forecast.steps+1}, (_,i) => {
    const d = new Date(lastDate);
    d.setDate(d.getDate() + i);
    return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  });

  const allLabels = [...histDates, ...fwdDates.slice(1)];

  // Build percentile arrays (padded with nulls for history)
  const pad = new Array(histN-1).fill(null);
  const p50 = [...pad, ...forecast.percentiles.map(p => p.p50)];
  const p25 = [...pad, ...forecast.percentiles.map(p => p.p25)];
  const p75 = [...pad, ...forecast.percentiles.map(p => p.p75)];
  const p5  = [...pad, ...forecast.percentiles.map(p => p.p5)];
  const p95 = [...pad, ...forecast.percentiles.map(p => p.p95)];

  // Regression channel
  const regLine = [...pad, ...forecast.regFwd];
  const regUp = [...pad, ...forecast.regFwd.map(v => v + forecast.regStd)];
  const regDn = [...pad, ...forecast.regFwd.map(v => v - forecast.regStd)];

  const histData = [...histClose, ...new Array(forecast.steps).fill(null)];

  forecastChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: allLabels,
      datasets: [
        { label: 'Price (30d)', data: histData, borderColor: 'rgba(160,168,184,0.9)', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 },
        { label: 'Reg Upper', data: regUp, borderColor: 'rgba(201,168,76,0.3)', borderWidth: 1, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(201,168,76,0.05)', tension: 0.3 },
        { label: 'Reg Lower', data: regDn, borderColor: 'rgba(201,168,76,0.3)', borderWidth: 1, pointRadius: 0, fill: false, tension: 0.3 },
        { label: 'Reg Trend', data: regLine, borderColor: 'rgba(201,168,76,0.5)', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3, borderDash: [6,3] },
        { label: 'P95', data: p95, borderColor: 'rgba(76,175,125,0.1)', borderWidth: 1, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(76,175,125,0.04)', tension: 0.4 },
        { label: 'P75 Bull', data: p75, borderColor: 'rgba(0,255,136,0.4)', borderWidth: 1.5, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(76,175,125,0.07)', tension: 0.4 },
        { label: 'P50 Median', data: p50, borderColor: '#ffffff', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.4 },
        { label: 'P25 Bear', data: p25, borderColor: 'rgba(192,82,74,0.35)', borderWidth: 1.5, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(192,82,74,0.07)', tension: 0.4 },
        { label: 'P5', data: p5, borderColor: 'rgba(192,82,74,0.1)', borderWidth: 1, pointRadius: 0, fill: false, tension: 0.4 },
      ]
    },
    options: chartOptions('30-Day Monte Carlo Forecast', true)
  });
}

function chartOptions(label, showLegend) {
  return {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { intersect: false, mode: 'index' },
    plugins: {
      legend: {
        display: showLegend,
        labels: { color: 'rgba(140,138,130,0.7)', font: { family: 'Share Tech Mono', size: 10 }, boxWidth: 12, padding: 10 }
      },
      tooltip: {
        backgroundColor: 'rgba(14,14,16,0.96)',
        borderColor: 'rgba(255,255,255,0.08)',
        borderWidth: 1,
        titleColor: '#c9a84c',
        bodyColor: 'rgba(210,208,200,0.8)',
        titleFont: { family: 'DM Mono', size: 11 },
        bodyFont: { family: 'DM Mono', size: 11 },
        callbacks: {
          label: ctx => {
            const v = ctx.parsed.y;
            if (v == null) return null;
            return ` ${ctx.dataset.label}: ${typeof v === 'number' ? v.toFixed(2) : v}`;
          }
        }
      }
    },
    scales: {
      x: {
        ticks: {
          color: 'rgba(120,120,110,0.7)', font: { family: 'Share Tech Mono', size: 9 },
          maxTicksLimit: 10, maxRotation: 0
        },
        grid: { color: 'rgba(255,255,255,0.04)', borderColor: 'rgba(255,255,255,0.07)' }
      },
      y: {
        position: 'right',
        ticks: { color: 'rgba(120,120,110,0.7)', font: { family: 'Share Tech Mono', size: 9 } },
        grid: { color: 'rgba(255,255,255,0.04)', borderColor: 'rgba(255,255,255,0.07)' }
      }
    }
  };
}

// ── AI CONSULTANT ──
async function autoConsult(ticker, score, verdict, signals, ind, forecast, meta) {
  const c = ind.current;
  const fc = forecast.percentiles[forecast.steps];
  
  const context = `
STOCK: ${ticker} | PRICE: $${c.price.toFixed(2)}
QUANT SCORE: ${score}/100 | VERDICT: ${verdict}

TECHNICAL SIGNALS:
${signals.map(s => `  ${s.name}: ${s.value} → ${s.signal.toUpperCase()}`).join('\n')}

RISK METRICS:
  Historical Volatility (20d ann.): ${c.vol20 != null ? c.vol20.toFixed(1)+'%' : 'N/A'}
  ATR (14): $${c.atr != null ? c.atr.toFixed(2) : 'N/A'}
  RSI: ${c.rsi != null ? c.rsi.toFixed(1) : 'N/A'}
  Z-Score: ${c.zScore != null ? c.zScore.toFixed(2) : 'N/A'}

30-DAY MONTE CARLO FORECAST (500 paths, GBM):
  Bear Case (25th %ile): $${fc.p25.toFixed(2)} (${fmtChg(fc.p25, c.price)})
  Median (50th %ile):    $${fc.p50.toFixed(2)} (${fmtChg(fc.p50, c.price)})
  Bull Case (75th %ile): $${fc.p75.toFixed(2)} (${fmtChg(fc.p75, c.price)})

MOMENTUM:
  SMA20: $${c.sma20 != null ? c.sma20.toFixed(2) : 'N/A'} | SMA50: $${c.sma50 != null ? c.sma50.toFixed(2) : 'N/A'} | SMA200: $${c.sma200 != null ? c.sma200.toFixed(2) : 'N/A'}
  MACD Histogram: ${c.macdHist != null ? c.macdHist.toFixed(3) : 'N/A'}
  CMF: ${c.cmf != null ? c.cmf.toFixed(3) : 'N/A'}
  ADX: ${c.adx != null ? c.adx.toFixed(1) : 'N/A'}
`;

  chatHistory = [];
  const systemPrompt = `You are an elite quantitative analyst at a top-tier hedge fund, combining the mathematical rigor of Renaissance Technologies with the multi-strategy approach of Citadel. You have been given a complete quantitative analysis of a stock. Provide a sharp, precise, institutional-grade investment analysis.

Structure your response EXACTLY as follows:
1. **INVESTMENT THESIS** (2-3 sentences — what the quant signals say)
2. **KEY RISK FACTORS** (2-3 bullets)
3. **ENTRY ZONE & STOP-LOSS** (specific price levels)
4. **POSITION SIZING** (% of portfolio based on volatility using Kelly-inspired logic)
5. **PRICE LEVELS TO WATCH** (support/resistance, key triggers)

Be direct, reference specific signal values, use professional finance language. Keep it sharp and actionable.`;

  const userMsg = `Analyze this stock based on the following quantitative data:\n\n${context}`;
  
  addChatMsg('ai', '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>', 'typing-msg');
  
  chatHistory.push({ role: 'user', content: userMsg });
  
  try {
    const reply = await callGroq(systemPrompt, chatHistory);
    chatHistory.push({ role: 'assistant', content: reply });
    document.getElementById('typing-msg')?.remove();
    addChatMsg('ai', formatMarkdown(reply));
  } catch (e) {
    document.getElementById('typing-msg')?.remove();
    addChatMsg('ai', `⚠ AI Consultant unavailable. Please add your Groq API key at the top of the file (GROQ_API_KEY). Get a free key at console.groq.com`);
  }
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg || !currentAnalysis) return;

  input.value = '';
  document.getElementById('sendBtn').disabled = true;
  document.getElementById('chatStatus').textContent = 'Analyzing...';

  addChatMsg('user', msg);
  chatHistory.push({ role: 'user', content: msg });

  const typingEl = addChatMsg('ai', '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>', 'typing-msg2');

  const systemPrompt = `You are an elite quant analyst. The user is asking follow-up questions about ${currentAnalysis.ticker} stock analysis with Quant Score ${currentAnalysis.score}/100 (${currentAnalysis.verdict}). Be direct, precise, and quantitative. Reference specific metrics when relevant.`;

  try {
    const reply = await callGroq(systemPrompt, chatHistory);
    chatHistory.push({ role: 'assistant', content: reply });
    document.getElementById('typing-msg2')?.remove();
    addChatMsg('ai', formatMarkdown(reply));
  } catch(e) {
    document.getElementById('typing-msg2')?.remove();
    addChatMsg('ai', '⚠ API error: ' + e.message + '. Ensure your API key is set correctly.');
  }

  document.getElementById('sendBtn').disabled = false;
  document.getElementById('chatStatus').textContent = 'Ready';
}

async function callGroq(system, messages) {
  const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${GROQ_API_KEY}`
    },
    body: JSON.stringify({
      model: 'llama-3.3-70b-versatile',
      max_tokens: 1000,
      temperature: 0.7,
      messages: [
        { role: 'system', content: system },
        ...messages
      ]
    })
  });

  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    throw new Error(err.error?.message || 'Groq API request failed (' + response.status + ')');
  }

  const data = await response.json();
  return data.choices?.[0]?.message?.content || 'No response received.';
}

function formatMarkdown(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--gold)">$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/^(\d+)\. /gm, '<br><span style="color:var(--gold);opacity:0.7">$1.</span> ')
    .replace(/^- /gm, '<br>· ')
    .replace(/\n/g, '<br>');
}

function addChatMsg(role, content, id) {
  const container = document.getElementById('chatMsgs');
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  if (id) div.id = id;
  const avatar = role === 'ai' ? 'AI' : 'YOU';
  div.innerHTML = `<div class="msg-avatar">${avatar}</div><div class="msg-content">${content}</div>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}


// ── PASSWORD ──
const CORRECT_PASSWORD = '260558';

function checkPassword() {
  const input = document.getElementById('pwInput');
  const val = input.value.trim();
  if (val === CORRECT_PASSWORD) {
    const screen = document.getElementById('password-screen');
    screen.classList.add('unlocking');
    setTimeout(() => {
      screen.style.display = 'none';
      startIntroSlideshow();
    }, 800);
  } else {
    input.classList.add('error');
    document.getElementById('pwError').textContent = '⚠ INVALID ACCESS CODE — UNAUTHORIZED';
    setTimeout(() => {
      input.classList.remove('error');
      input.value = '';
      document.getElementById('pwError').textContent = '';
    }, 1800);
  }
}

// ── PARTICLE CANVAS (password screen) ──
(function initPwCanvas() {
  const canvas = document.getElementById('pw-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let W, H, particles = [];

  function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }

  function Particle() {
    this.x = Math.random() * W;
    this.y = Math.random() * H;
    this.vx = (Math.random() - 0.5) * 0.4;
    this.vy = (Math.random() - 0.5) * 0.4;
    this.alpha = Math.random() * 0.5 + 0.1;
    this.size = Math.random() * 2 + 0.5;
    this.color = Math.random() > 0.5 ? '0,207,255' : '0,255,136';
  }

  function initParticles() {
    particles = Array.from({length: 120}, () => new Particle());
  }

  function drawConnections() {
    for (let i = 0; i < particles.length; i++) {
      for (let j = i+1; j < particles.length; j++) {
        const dx = particles[i].x - particles[j].x;
        const dy = particles[i].y - particles[j].y;
        const dist = Math.sqrt(dx*dx+dy*dy);
        if (dist < 120) {
          ctx.strokeStyle = `rgba(0,207,255,${0.15*(1-dist/120)})`;
          ctx.lineWidth = 0.5;
          ctx.beginPath();
          ctx.moveTo(particles[i].x, particles[i].y);
          ctx.lineTo(particles[j].x, particles[j].y);
          ctx.stroke();
        }
      }
    }
  }

  function animate() {
    if (document.getElementById('password-screen').style.display === 'none') return;
    ctx.clearRect(0,0,W,H);
    drawConnections();
    particles.forEach(p => {
      p.x += p.vx; p.y += p.vy;
      if (p.x < 0 || p.x > W) p.vx *= -1;
      if (p.y < 0 || p.y > H) p.vy *= -1;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
      ctx.fillStyle = `rgba(${p.color},${p.alpha})`;
      ctx.fill();
    });
    requestAnimationFrame(animate);
  }

  resize();
  initParticles();
  animate();
  window.addEventListener('resize', () => { resize(); initParticles(); });
  document.getElementById('pwInput').focus();
})();

// ── INTRO SLIDESHOW ──
let slideIndex = 0;
const totalSlides = 4;
let slideTimer = null;

function startIntroSlideshow() {
  const ss = document.getElementById('intro-slideshow');
  ss.style.display = 'block';
  slideIndex = 0;
  showSlide(0);
  initSlideCanvas();
  slideTimer = setInterval(() => {
    slideIndex++;
    if (slideIndex >= totalSlides) { endSlideshow(); return; }
    showSlide(slideIndex);
  }, 2800);
}

function showSlide(idx) {
  document.querySelectorAll('.slide').forEach((s,i) => s.classList.toggle('active', i===idx));
  document.querySelectorAll('.slide-dot').forEach((d,i) => d.classList.toggle('active', i===idx));
}

function endSlideshow() {
  clearInterval(slideTimer);
  const ss = document.getElementById('intro-slideshow');
  ss.style.transition = 'opacity 0.6s ease';
  ss.style.opacity = '0';
  setTimeout(() => { ss.style.display = 'none'; ss.style.opacity = '1'; }, 600);
}

function initSlideCanvas() {
  const canvas = document.getElementById('slide-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let W, H;
  function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
  resize();

  const lines = Array.from({length: 30}, () => ({
    x: Math.random() * W, y: Math.random() * H,
    len: Math.random() * 200 + 50,
    angle: Math.random() * Math.PI * 2,
    speed: Math.random() * 0.3 + 0.1,
    alpha: Math.random() * 0.15 + 0.03,
    color: Math.random() > 0.5 ? '0,207,255' : '0,255,136'
  }));

  function animSlide() {
    if (document.getElementById('intro-slideshow').style.display === 'none') return;
    ctx.clearRect(0,0,W,H);
    lines.forEach(l => {
      l.angle += l.speed * 0.01;
      ctx.strokeStyle = `rgba(${l.color},${l.alpha})`;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(l.x, l.y);
      ctx.lineTo(l.x + Math.cos(l.angle)*l.len, l.y + Math.sin(l.angle)*l.len);
      ctx.stroke();
    });
    requestAnimationFrame(animSlide);
  }
  animSlide();
}

// ── THEME TOGGLE ──
let isDark = true;
function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle('light', !isDark);
  document.getElementById('themeBtn').textContent = isDark ? '🌙' : '☀️';

  // Update charts if visible
  if (currentAnalysis) {
    const { prices, volumes, dates, indicators, forecast, score, verdict, signals } = currentAnalysis;
    // Re-render charts with new theme
    renderPriceChart(dates, prices.close, indicators);
    renderMacdChart(dates, indicators);
    renderRsiChart(dates, indicators);
    renderForecastChart(prices.close, forecast, dates);
  }
}

// ── UI HELPERS ──
function showLoading(ticker) {
   document.getElementById('welcome-screen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'none';
  const ls =  document.getElementById('loading-screen');
  ls.style.display = 'flex';
  document.getElementById('loadingTicker').textContent = ticker;
  document.getElementById('loadingStatus').textContent = 'Initialising...';
}

function setStep(n) {
  
}

function showWelcome(show=true) {
   document.getElementById('welcome-screen').style.display = show ? 'flex' : 'none';
   document.getElementById('loading-screen').style.display = 'none';
  if (!show) return;
  document.getElementById('dashboard').style.display = 'none';
}

function showError(msg) {
  const el = document.getElementById('errBanner');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 8000);
}

function hideError() {
  document.getElementById('errBanner').style.display = 'none';
}

function setStatus(msg) {
  document.getElementById('statusText').textContent = msg;
}

</script>
</body>
</html>
