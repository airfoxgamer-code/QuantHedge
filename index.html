<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QuantEdge — Personal Hedge Fund Terminal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #050810;
    --bg2: #080d1a;
    --bg3: #0d1526;
    --card: #0a1020;
    --border: #1a2540;
    --border2: #243050;
    --green: #00ff88;
    --green2: #00cc6a;
    --cyan: #00cfff;
    --cyan2: #0099cc;
    --yellow: #ffd700;
    --orange: #ff9500;
    --red: #ff4466;
    --red2: #cc2244;
    --purple: #8866ff;
    --text: #c8d8f0;
    --text2: #7a90b0;
    --text3: #3a5070;
    --glow-green: 0 0 20px rgba(0,255,136,0.3);
    --glow-cyan: 0 0 20px rgba(0,207,255,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.05) 2px, rgba(0,0,0,0.05) 4px);
    pointer-events: none;
    z-index: 9999;
  }

  /* Grid background */
  body::after {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: 
      linear-gradient(rgba(0,207,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,207,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* ── HEADER ── */
  header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(5,8,16,0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }

  .logo-icon {
    width: 36px; height: 36px;
    border: 2px solid var(--green);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    color: var(--green);
    box-shadow: var(--glow-green);
    animation: pulse-border 2s ease-in-out infinite;
  }

  @keyframes pulse-border {
    0%, 100% { box-shadow: 0 0 10px rgba(0,255,136,0.3); }
    50% { box-shadow: 0 0 25px rgba(0,255,136,0.6); }
  }

  .logo-text {
    font-family: 'Orbitron', monospace;
    font-size: 18px;
    font-weight: 700;
    color: var(--cyan);
    letter-spacing: 3px;
    text-shadow: var(--glow-cyan);
  }

  .logo-sub {
    font-size: 10px;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .search-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
    max-width: 500px;
  }

  .search-bar input {
    flex: 1;
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--green);
    font-family: 'Share Tech Mono', monospace;
    font-size: 18px;
    padding: 10px 16px;
    letter-spacing: 4px;
    text-transform: uppercase;
    outline: none;
    transition: all 0.3s;
  }

  .search-bar input:focus {
    border-color: var(--green);
    box-shadow: var(--glow-green);
    background: rgba(0,255,136,0.05);
  }

  .search-bar input::placeholder {
    color: var(--text3);
    letter-spacing: 2px;
    font-size: 14px;
  }

  .btn-analyze {
    background: transparent;
    border: 2px solid var(--green);
    color: var(--green);
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 2px;
    padding: 10px 24px;
    cursor: pointer;
    transition: all 0.3s;
    text-transform: uppercase;
    position: relative;
    overflow: hidden;
  }

  .btn-analyze::before {
    content: '';
    position: absolute;
    top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0,255,136,0.2), transparent);
    transition: left 0.4s;
  }

  .btn-analyze:hover::before { left: 100%; }
  .btn-analyze:hover {
    background: rgba(0,255,136,0.1);
    box-shadow: var(--glow-green);
  }

  .btn-analyze:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .header-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--text3);
    font-family: 'Share Tech Mono', monospace;
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
    animation: blink 1.5s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* ── MAIN CONTENT ── */
  main {
    position: relative;
    z-index: 1;
    padding: 20px 24px;
    max-width: 1600px;
    margin: 0 auto;
  }

  /* ── WELCOME / IDLE STATE ── */
  #welcome-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 70vh;
    text-align: center;
    gap: 24px;
  }

  .welcome-title {
    font-family: 'Orbitron', monospace;
    font-size: 48px;
    font-weight: 900;
    color: var(--cyan);
    text-shadow: 0 0 40px rgba(0,207,255,0.5);
    line-height: 1.1;
  }

  .welcome-sub {
    font-size: 18px;
    color: var(--text2);
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .welcome-features {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 20px;
  }

  .feature-pill {
    background: var(--bg3);
    border: 1px solid var(--border2);
    padding: 8px 16px;
    font-size: 13px;
    color: var(--text2);
    letter-spacing: 1px;
  }

  .feature-pill span { color: var(--green); }

  /* ── LOADING STATE ── */
  #loading-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    gap: 24px;
  }

  .loading-ticker {
    font-family: 'Orbitron', monospace;
    font-size: 48px;
    color: var(--green);
    text-shadow: var(--glow-green);
    letter-spacing: 8px;
  }

  .loading-bar-wrap {
    width: 400px;
    height: 4px;
    background: var(--bg3);
    position: relative;
    overflow: hidden;
  }

  .loading-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--green), var(--cyan));
    animation: loading-progress 2s ease-in-out infinite;
    box-shadow: 0 0 10px var(--green);
  }

  @keyframes loading-progress {
    0% { width: 0%; margin-left: 0; }
    50% { width: 80%; margin-left: 0; }
    100% { width: 0%; margin-left: 100%; }
  }

  .loading-steps {
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: var(--text2);
    text-align: center;
    line-height: 2;
  }

  .loading-step { color: var(--text3); }
  .loading-step.active { color: var(--green); }
  .loading-step.done { color: var(--text2); }

  /* ── DASHBOARD ── */
  #dashboard { display: none; }

  /* ── TICKER HEADER BAR ── */
  .ticker-bar {
    background: var(--card);
    border: 1px solid var(--border);
    padding: 16px 24px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 32px;
    flex-wrap: wrap;
  }

  .ticker-name {
    font-family: 'Orbitron', monospace;
    font-size: 28px;
    font-weight: 700;
    color: var(--cyan);
    letter-spacing: 4px;
  }

  .ticker-company {
    font-size: 14px;
    color: var(--text2);
    letter-spacing: 1px;
  }

  .ticker-price {
    font-family: 'Share Tech Mono', monospace;
    font-size: 32px;
    color: var(--green);
    text-shadow: var(--glow-green);
  }

  .ticker-change {
    font-family: 'Share Tech Mono', monospace;
    font-size: 18px;
    padding: 4px 10px;
    border: 1px solid;
  }

  .ticker-change.up { color: var(--green); border-color: var(--green); background: rgba(0,255,136,0.08); }
  .ticker-change.down { color: var(--red); border-color: var(--red); background: rgba(255,68,102,0.08); }

  .ticker-meta {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    margin-left: auto;
  }

  .meta-item { text-align: right; }
  .meta-label { font-size: 10px; color: var(--text3); letter-spacing: 2px; text-transform: uppercase; }
  .meta-value { font-family: 'Share Tech Mono', monospace; font-size: 14px; color: var(--text); margin-top: 2px; }

  .last-updated {
    font-size: 11px;
    color: var(--text3);
    font-family: 'Share Tech Mono', monospace;
    margin-left: auto;
  }

  /* ── GRID LAYOUTS ── */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 16px;
    margin-bottom: 16px;
  }

  .grid-charts {
    display: grid;
    gap: 16px;
    margin-bottom: 16px;
  }

  /* ── CARDS ── */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 3px; height: 100%;
    background: linear-gradient(180deg, var(--cyan), transparent);
  }

  .card-title {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    font-weight: 700;
    color: var(--text3);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* ── QUANT SCORE GAUGE ── */
  .gauge-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .gauge-svg {
    width: 200px;
    height: 120px;
  }

  .gauge-score {
    font-family: 'Orbitron', monospace;
    font-size: 48px;
    font-weight: 900;
    text-align: center;
    line-height: 1;
  }

  .gauge-verdict {
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 3px;
    text-align: center;
    padding: 8px 20px;
    border: 2px solid;
  }

  .verdict-strong-buy { color: var(--green); border-color: var(--green); background: rgba(0,255,136,0.1); text-shadow: var(--glow-green); }
  .verdict-buy { color: #66ff99; border-color: #66ff99; background: rgba(102,255,153,0.1); }
  .verdict-neutral { color: var(--yellow); border-color: var(--yellow); background: rgba(255,215,0,0.1); }
  .verdict-sell { color: var(--orange); border-color: var(--orange); background: rgba(255,149,0,0.1); }
  .verdict-strong-sell { color: var(--red); border-color: var(--red); background: rgba(255,68,102,0.1); }

  .confidence-bar-wrap {
    width: 100%;
    margin-top: 8px;
  }

  .confidence-label {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text2);
    margin-bottom: 6px;
    font-family: 'Share Tech Mono', monospace;
  }

  .confidence-bar {
    height: 6px;
    background: var(--bg3);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--cyan), var(--green));
    box-shadow: 0 0 10px var(--green);
    transition: width 1.5s cubic-bezier(0.4,0,0.2,1);
  }

  /* ── SIGNAL TABLE ── */
  .signal-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .signal-table th {
    font-family: 'Share Tech Mono', monospace;
    font-size: 10px;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  .signal-table td {
    padding: 8px 10px;
    border-bottom: 1px solid rgba(26,37,64,0.5);
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--text2);
  }

  .signal-table tr:hover td { background: rgba(255,255,255,0.02); }

  .sig-indicator { color: var(--text); font-weight: 500; font-family: 'Rajdhani', sans-serif; font-size: 13px; }
  .sig-bullish { color: var(--green); }
  .sig-bearish { color: var(--red); }
  .sig-neutral { color: var(--yellow); }

  .sig-dot {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 6px;
  }

  .dot-bull { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .dot-bear { background: var(--red); box-shadow: 0 0 6px var(--red); }
  .dot-neut { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }

  /* ── RISK METRICS ── */
  .risk-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .risk-item {
    background: var(--bg3);
    border: 1px solid var(--border);
    padding: 12px;
  }

  .risk-label {
    font-size: 10px;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
    font-family: 'Share Tech Mono', monospace;
    margin-bottom: 6px;
  }

  .risk-value {
    font-family: 'Share Tech Mono', monospace;
    font-size: 20px;
    color: var(--cyan);
  }

  .risk-sub {
    font-size: 11px;
    color: var(--text3);
    margin-top: 3px;
  }

  /* ── FORECAST STATS ── */
  .forecast-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }

  .forecast-item {
    background: var(--bg3);
    border: 1px solid var(--border);
    padding: 14px;
    text-align: center;
  }

  .forecast-label {
    font-size: 10px;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
    font-family: 'Share Tech Mono', monospace;
    margin-bottom: 8px;
  }

  .forecast-price {
    font-family: 'Share Tech Mono', monospace;
    font-size: 22px;
  }

  .forecast-change {
    font-size: 12px;
    margin-top: 4px;
    font-family: 'Share Tech Mono', monospace;
  }

  /* ── AI CHAT ── */
  .chat-panel {
    background: var(--card);
    border: 1px solid var(--border);
    margin-bottom: 20px;
    overflow: hidden;
  }

  .chat-header {
    background: var(--bg3);
    border-bottom: 1px solid var(--border);
    padding: 14px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .chat-ai-icon {
    width: 32px; height: 32px;
    background: linear-gradient(135deg, var(--cyan), var(--purple));
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
  }

  .chat-ai-name {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    color: var(--cyan);
    letter-spacing: 2px;
  }

  .chat-ai-status {
    font-size: 11px;
    color: var(--text3);
    font-family: 'Share Tech Mono', monospace;
  }

  .chat-messages {
    height: 380px;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    scroll-behavior: smooth;
  }

  .chat-messages::-webkit-scrollbar { width: 4px; }
  .chat-messages::-webkit-scrollbar-track { background: var(--bg); }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border2); }

  .msg {
    display: flex;
    gap: 12px;
    animation: msg-appear 0.3s ease;
  }

  @keyframes msg-appear {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg-avatar {
    width: 32px; height: 32px;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px;
    font-family: 'Orbitron', monospace;
  }

  .msg.ai .msg-avatar { background: linear-gradient(135deg, var(--cyan), var(--purple)); color: white; }
  .msg.user .msg-avatar { background: var(--bg3); border: 1px solid var(--border2); color: var(--text2); }
  .msg.user { flex-direction: row-reverse; }

  .msg-content {
    max-width: 80%;
    background: var(--bg3);
    border: 1px solid var(--border);
    padding: 12px 16px;
    font-size: 14px;
    line-height: 1.7;
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
  }

  .msg.ai .msg-content { border-left: 3px solid var(--cyan); }
  .msg.user .msg-content { border-right: 3px solid var(--green); }

  .typing-indicator {
    display: flex;
    gap: 4px;
    align-items: center;
    padding: 4px 0;
  }

  .typing-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--cyan);
    animation: typing 1.2s ease-in-out infinite;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.3); }
  }

  .chat-input-row {
    display: flex;
    border-top: 1px solid var(--border);
  }

  .chat-input {
    flex: 1;
    background: transparent;
    border: none;
    padding: 14px 20px;
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    outline: none;
  }

  .chat-input::placeholder { color: var(--text3); }

  .btn-send {
    background: transparent;
    border: none;
    border-left: 1px solid var(--border);
    color: var(--green);
    padding: 14px 24px;
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-send:hover { background: rgba(0,255,136,0.1); }
  .btn-send:disabled { opacity: 0.3; cursor: not-allowed; }

  /* ── CHART CONTAINER ── */
  .chart-container {
    position: relative;
    width: 100%;
  }

  /* ── FOOTER ── */
  footer {
    text-align: center;
    padding: 20px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text3);
    letter-spacing: 2px;
    font-family: 'Share Tech Mono', monospace;
    position: relative;
    z-index: 1;
  }

  /* ── ERROR BANNER ── */
  .error-banner {
    display: none;
    background: rgba(255,68,102,0.1);
    border: 1px solid var(--red);
    color: var(--red);
    padding: 14px 20px;
    margin-bottom: 16px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    letter-spacing: 1px;
  }

  /* ── SCROLLBAR ── */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); }
  ::-webkit-scrollbar-thumb:hover { background: var(--text3); }

  /* ── CHART HEIGHT ── */
  #priceChart { height: 320px !important; }
  #macdChart { height: 140px !important; }
  #rsiChart { height: 120px !important; }
  #forecastChart { height: 280px !important; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">QE</div>
    <div>
      <div class="logo-text">QUANTEDGE</div>
      <div class="logo-sub">Hedge Fund Terminal</div>
    </div>
  </div>

  <div class="search-bar">
    <input type="text" id="tickerInput" placeholder="Enter ticker... AAPL, TSLA, NVDA" maxlength="10">
    <button class="btn-analyze" id="analyzeBtn" onclick="startAnalysis()">ANALYZE</button>
  </div>

  <div class="header-status">
    <div class="status-dot"></div>
    <span id="statusText">SYSTEM READY</span>
  </div>
</header>

<main>
  <div id="errorBanner" class="error-banner"></div>

  <!-- WELCOME -->
  <div id="welcome-screen">
    <div>
      <div class="welcome-title">QUANTEDGE</div>
      <div class="welcome-title" style="font-size:24px; color: var(--text2); margin-top: 8px;">PERSONAL HEDGE FUND TERMINAL</div>
    </div>
    <div class="welcome-sub">Renaissance-Inspired Quantitative Analysis Engine</div>
    <div class="welcome-features">
      <div class="feature-pill"><span>◈</span> 12+ Technical Indicators</div>
      <div class="feature-pill"><span>◈</span> Monte Carlo Forecasting</div>
      <div class="feature-pill"><span>◈</span> Composite Quant Score</div>
      <div class="feature-pill"><span>◈</span> VaR & Risk Metrics</div>
      <div class="feature-pill"><span>◈</span> AI Quant Consultant</div>
      <div class="feature-pill"><span>◈</span> Statistical Arbitrage Signals</div>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loading-screen">
    <div class="loading-ticker" id="loadingTicker">---</div>
    <div class="loading-bar-wrap">
      <div class="loading-bar"></div>
    </div>
    <div class="loading-steps" id="loadingSteps">
      <div class="loading-step" id="step1">► Fetching market data...</div>
      <div class="loading-step" id="step2">► Computing technical indicators...</div>
      <div class="loading-step" id="step3">► Running Monte Carlo simulation...</div>
      <div class="loading-step" id="step4">► Generating quant signals...</div>
      <div class="loading-step" id="step5">► Consulting AI analyst...</div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard">
    <!-- Ticker Bar -->
    <div class="ticker-bar">
      <div>
        <div class="ticker-name" id="db-ticker">---</div>
        <div class="ticker-company" id="db-company">---</div>
      </div>
      <div class="ticker-price" id="db-price">$---</div>
      <div class="ticker-change" id="db-change">---</div>
      <div class="ticker-meta">
        <div class="meta-item">
          <div class="meta-label">Volume</div>
          <div class="meta-value" id="db-volume">---</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Mkt Cap</div>
          <div class="meta-value" id="db-mktcap">---</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">52W High</div>
          <div class="meta-value" id="db-52h">---</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">52W Low</div>
          <div class="meta-value" id="db-52l">---</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">P/E</div>
          <div class="meta-value" id="db-pe">---</div>
        </div>
      </div>
      <div class="last-updated" id="db-updated">---</div>
    </div>

    <!-- Main Grid -->
    <div class="grid-2">
      <!-- Left: Charts -->
      <div>
        <div class="card" style="margin-bottom:16px;">
          <div class="card-title">◈ Price Action — Moving Averages — Bollinger Bands</div>
          <div class="chart-container">
            <canvas id="priceChart"></canvas>
          </div>
        </div>
        <div class="card" style="margin-bottom:16px;">
          <div class="card-title">◈ MACD (12,26,9)</div>
          <div class="chart-container">
            <canvas id="macdChart"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-title">◈ RSI (14) — Relative Strength Index</div>
          <div class="chart-container">
            <canvas id="rsiChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Right: Score + Signals + Risk -->
      <div style="display:flex; flex-direction:column; gap:16px;">
        <!-- Quant Score -->
        <div class="card">
          <div class="card-title">◈ Composite Quant Score</div>
          <div class="gauge-wrap">
            <svg class="gauge-svg" viewBox="0 0 200 120">
              <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#1a2540" stroke-width="16" stroke-linecap="round"/>
              <path id="gaugeFill" d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#00ff88" stroke-width="16" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
              <text x="100" y="85" text-anchor="middle" font-family="Orbitron" font-size="36" font-weight="900" fill="#00ff88" id="gaugeText">--</text>
              <text x="100" y="108" text-anchor="middle" font-family="Share Tech Mono" font-size="10" fill="#3a5070">QUANT SCORE</text>
            </svg>
            <div class="gauge-verdict" id="gaugeVerdict">ANALYZING...</div>
            <div class="confidence-bar-wrap">
              <div class="confidence-label">
                <span>Signal Confidence</span>
                <span id="confidenceVal">0%</span>
              </div>
              <div class="confidence-bar">
                <div class="confidence-fill" id="confidenceFill" style="width:0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Signal Table -->
        <div class="card" style="flex:1;">
          <div class="card-title">◈ Signal Breakdown</div>
          <table class="signal-table">
            <thead>
              <tr>
                <th>Indicator</th>
                <th>Value</th>
                <th>Signal</th>
              </tr>
            </thead>
            <tbody id="signalTableBody">
              <!-- filled by JS -->
            </tbody>
          </table>
        </div>

        <!-- Risk Metrics -->
        <div class="card">
          <div class="card-title">◈ Risk Metrics</div>
          <div class="risk-grid">
            <div class="risk-item">
              <div class="risk-label">Hist. Volatility</div>
              <div class="risk-value" id="rm-vol">--</div>
              <div class="risk-sub">20-day annualized</div>
            </div>
            <div class="risk-item">
              <div class="risk-label">VaR 95%</div>
              <div class="risk-value" id="rm-var">--</div>
              <div class="risk-sub">Daily loss estimate</div>
            </div>
            <div class="risk-item">
              <div class="risk-label">ATR (14)</div>
              <div class="risk-value" id="rm-atr">--</div>
              <div class="risk-sub">Avg True Range</div>
            </div>
            <div class="risk-item">
              <div class="risk-label">Sharpe Est.</div>
              <div class="risk-value" id="rm-sharpe">--</div>
              <div class="risk-sub">252-day rolling</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Monte Carlo Forecast -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title">◈ Monte Carlo Price Forecast — 30-Day Simulation (500 Paths) + Regression Channel</div>
      <div class="forecast-stats" id="forecastStats">
        <div class="forecast-item">
          <div class="forecast-label">Current Price</div>
          <div class="forecast-price" id="fc-current" style="color:var(--cyan)">--</div>
        </div>
        <div class="forecast-item">
          <div class="forecast-label">30D Median</div>
          <div class="forecast-price" id="fc-median" style="color:var(--text)">--</div>
          <div class="forecast-change" id="fc-median-chg">--</div>
        </div>
        <div class="forecast-item">
          <div class="forecast-label">Bull Case (75th %ile)</div>
          <div class="forecast-price" id="fc-bull" style="color:var(--green)">--</div>
          <div class="forecast-change" id="fc-bull-chg" style="color:var(--green)">--</div>
        </div>
        <div class="forecast-item">
          <div class="forecast-label">Bear Case (25th %ile)</div>
          <div class="forecast-price" id="fc-bear" style="color:var(--red)">--</div>
          <div class="forecast-change" id="fc-bear-chg" style="color:var(--red)">--</div>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="forecastChart"></canvas>
      </div>
    </div>

    <!-- AI Chat -->
    <div class="chat-panel">
      <div class="chat-header">
        <div class="chat-ai-icon">⬡</div>
        <div>
          <div class="chat-ai-name">QUANT AI CONSULTANT</div>
          <div class="chat-ai-status" id="chatStatus">Powered by Gemini 2.0 Flash — Ready</div>
        </div>
        <div style="margin-left:auto; font-size:11px; color:var(--text3); font-family:'Share Tech Mono',monospace;">
          Google Gemini AI • Free API
        </div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="msg ai">
          <div class="msg-avatar">AI</div>
          <div class="msg-content">
            Initializing Quant AI Consultant. Analyze a stock to receive an institutional-grade investment thesis, risk assessment, and actionable recommendations powered by quantitative signals and AI reasoning.
          </div>
        </div>
      </div>
      <div class="chat-input-row">
        <input type="text" class="chat-input" id="chatInput" placeholder="Ask follow-up questions... e.g. 'What's the optimal entry price?' or 'How does this compare to sector?'" onkeydown="if(event.key==='Enter') sendChat()">
        <button class="btn-send" id="sendBtn" onclick="sendChat()">SEND ►</button>
      </div>
    </div>
  </div>
</main>

<footer>
  ⚠ FOR EDUCATIONAL PURPOSES ONLY — NOT FINANCIAL ADVICE — QUANTEDGE TERMINAL © 2025 — PAST PERFORMANCE DOES NOT GUARANTEE FUTURE RESULTS
</footer>

<script>
const GEMINI_API_KEY = "AIzaSyCJHL60likjwHl6BneG8LcCaMlLVgfGC7s";

// ── STATE ──
let priceChart, macdChart, rsiChart, forecastChart;
let chatHistory = [];
let currentAnalysis = null;

// ── ENTRY ──
document.getElementById('tickerInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') startAnalysis();
});

async function startAnalysis() {
  const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
  if (!ticker) return;

  hideError();
  showLoading(ticker);
  setStatus('FETCHING DATA...');
  document.getElementById('analyzeBtn').disabled = true;

  try {
    setStep(1);
    const { prices, volumes, dates, meta } = await fetchData(ticker);

    setStep(2);
    const indicators = computeIndicators(prices, volumes);

    setStep(3);
    const forecast = runMonteCarlo(prices);

    setStep(4);
    const { score, verdict, signals } = computeQuantScore(indicators, prices);

    setStep(5);
    showDashboard(ticker, prices, volumes, dates, meta, indicators, forecast, score, verdict, signals);

    currentAnalysis = { ticker, prices, volumes, dates, meta, indicators, forecast, score, verdict, signals };
    chatHistory = [];

    await autoConsult(ticker, score, verdict, signals, indicators, forecast, meta);

  } catch (err) {
    showError('Error: ' + err.message);
    showWelcome();
  }

  setStatus('SYSTEM READY');
  document.getElementById('analyzeBtn').disabled = false;
}

// ── DATA FETCH ──
async function fetchData(ticker) {
  // Try multiple CORS proxies in order
  const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1y`;
  const proxies = [
    `https://corsproxy.io/?url=${encodeURIComponent(yahooUrl)}`,
    `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`,
    `https://cors-anywhere.herokuapp.com/${yahooUrl}`
  ];

  let json = null;
  let lastErr = '';
  for (const proxyUrl of proxies) {
    try {
      const res = await fetch(proxyUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!res.ok) continue;
      const raw = await res.json();
      // allorigins wraps response in {contents: "..."}
      json = raw.contents ? JSON.parse(raw.contents) : raw;
      if (json?.chart?.result?.[0]) break;
    } catch(e) { lastErr = e.message; }
  }
  if (!json?.chart?.result?.[0]) throw new Error(`Ticker '${ticker}' not found or all data sources failed. (${lastErr})`);

  const result = json.chart?.result?.[0];
  if (!result) throw new Error(`No data returned for ${ticker}`);

  const timestamps = result.timestamp;
  const q = result.indicators.quote[0];
  const closes = q.close;
  const volumes = q.volume;
  const highs = q.high;
  const lows = q.low;

  // Filter out null values
  const valid = timestamps.map((t,i) => ({
    date: new Date(t * 1000),
    close: closes[i],
    volume: volumes[i],
    high: highs[i],
    low: lows[i]
  })).filter(d => d.close != null && d.volume != null);

  const prices = { close: valid.map(d=>d.close), high: valid.map(d=>d.high), low: valid.map(d=>d.low) };
  const vols = valid.map(d => d.volume);
  const dates = valid.map(d => d.date.toLocaleDateString('en-US', {month:'short',day:'numeric'}));

  // Get meta
  const m = result.meta;
  const meta = {
    ticker,
    name: m.shortName || m.symbol || ticker,
    price: m.regularMarketPrice || valid[valid.length-1].close,
    prevClose: m.previousClose || m.chartPreviousClose,
    volume: m.regularMarketVolume,
    mktCap: null,
    high52: m.fiftyTwoWeekHigh,
    low52: m.fiftyTwoWeekLow,
    pe: null,
    exchange: m.exchangeName || ''
  };

  return { prices, volumes: vols, dates, meta };
}

// ── INDICATORS ──
function computeIndicators(prices, volumes) {
  const c = prices.close;
  const h = prices.high;
  const l = prices.low;
  const n = c.length;

  function sma(arr, p) {
    return arr.map((_, i) => i < p-1 ? null : avg(arr.slice(i-p+1, i+1)));
  }

  function ema(arr, p) {
    const k = 2/(p+1);
    const res = new Array(arr.length).fill(null);
    let start = arr.findIndex(v => v != null);
    res[start + p - 1] = avg(arr.slice(start, start+p));
    for (let i = start+p; i < arr.length; i++) {
      res[i] = arr[i] * k + res[i-1] * (1-k);
    }
    return res;
  }

  function avg(arr) { return arr.reduce((a,b)=>a+b,0)/arr.length; }
  function std(arr) {
    const m = avg(arr);
    return Math.sqrt(arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length);
  }

  const sma20 = sma(c, 20);
  const sma50 = sma(c, 50);
  const sma200 = sma(c, 200);
  const ema12 = ema(c, 12);
  const ema26 = ema(c, 26);

  // MACD
  const macdLine = ema12.map((v,i) => v != null && ema26[i] != null ? v - ema26[i] : null);
  const macdSignal = ema(macdLine.map(v => v ?? 0), 9).map((v,i) => macdLine[i] != null ? v : null);
  const macdHist = macdLine.map((v,i) => v != null && macdSignal[i] != null ? v - macdSignal[i] : null);

  // RSI
  const rsi = new Array(n).fill(null);
  if (n > 15) {
    let gains = 0, losses = 0;
    for (let i = 1; i <= 14; i++) {
      const d = c[i] - c[i-1];
      if (d > 0) gains += d; else losses -= d;
    }
    let avgG = gains/14, avgL = losses/14;
    rsi[14] = avgL === 0 ? 100 : 100 - 100/(1 + avgG/avgL);
    for (let i = 15; i < n; i++) {
      const d = c[i] - c[i-1];
      avgG = (avgG * 13 + (d > 0 ? d : 0)) / 14;
      avgL = (avgL * 13 + (d < 0 ? -d : 0)) / 14;
      rsi[i] = avgL === 0 ? 100 : 100 - 100/(1 + avgG/avgL);
    }
  }

  // Bollinger Bands
  const bbUpper = [], bbLower = [], bbMid = [];
  for (let i = 0; i < n; i++) {
    if (i < 19) { bbUpper.push(null); bbLower.push(null); bbMid.push(null); continue; }
    const slice = c.slice(i-19, i+1);
    const m = avg(slice);
    const s = std(slice);
    bbMid.push(m);
    bbUpper.push(m + 2*s);
    bbLower.push(m - 2*s);
  }

  // Z-score
  const zScore = c.map((v,i) => {
    if (i < 19) return null;
    const slice = c.slice(i-19, i+1);
    const m = avg(slice);
    const s = std(slice);
    return s > 0 ? (v - m)/s : 0;
  });

  // OBV
  const obv = [0];
  for (let i = 1; i < n; i++) {
    if (c[i] > c[i-1]) obv.push(obv[i-1] + volumes[i]);
    else if (c[i] < c[i-1]) obv.push(obv[i-1] - volumes[i]);
    else obv.push(obv[i-1]);
  }

  // Volume Z-score
  const volZ = volumes.map((v,i) => {
    if (i < 19) return 0;
    const slice = volumes.slice(i-19, i+1);
    const m = avg(slice);
    const s = std(slice);
    return s > 0 ? (v - m)/s : 0;
  });

  // ATR
  const atr14 = [];
  const tr = [0];
  for (let i = 1; i < n; i++) {
    tr.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
  }
  for (let i = 0; i < n; i++) {
    if (i < 14) { atr14.push(null); continue; }
    atr14.push(avg(tr.slice(i-13, i+1)));
  }

  // Historical Volatility (20-day annualized)
  const returns = c.map((v,i) => i === 0 ? 0 : Math.log(v/c[i-1]));
  const vol20 = returns.map((_, i) => {
    if (i < 20) return null;
    const r = returns.slice(i-19, i+1);
    return std(r) * Math.sqrt(252) * 100;
  });

  // CMF
  const cmf = [];
  for (let i = 0; i < n; i++) {
    if (i < 19) { cmf.push(null); continue; }
    let mfv = 0, vol = 0;
    for (let j = i-19; j <= i; j++) {
      const hl = h[j] - l[j];
      const mfm = hl > 0 ? ((c[j]-l[j]) - (h[j]-c[j]))/hl : 0;
      mfv += mfm * volumes[j];
      vol += volumes[j];
    }
    cmf.push(vol > 0 ? mfv/vol : 0);
  }

  // ROC
  const roc10 = c.map((v,i) => i < 10 ? null : (v/c[i-10] - 1)*100);

  // ADX
  const adx = computeADX(h, l, c, 14);

  const last = n - 1;
  return {
    sma20, sma50, sma200, ema12, ema26,
    macdLine, macdSignal, macdHist,
    rsi, bbUpper, bbLower, bbMid,
    zScore, obv, volZ, atr14, vol20,
    cmf, roc10, adx,
    current: {
      price: c[last],
      sma20: sma20[last], sma50: sma50[last], sma200: sma200[last],
      rsi: rsi[last], macd: macdLine[last], macdSig: macdSignal[last],
      macdHist: macdHist[last],
      bbU: bbUpper[last], bbL: bbLower[last], bbM: bbMid[last],
      zScore: zScore[last], obv: obv[last], obvPrev: obv[last-5],
      volZ: volZ[last], atr: atr14[last],
      vol20: vol20[last], cmf: cmf[last],
      roc10: roc10[last], adx: adx[last],
      high52: Math.max(...c.slice(-252)),
      low52: Math.min(...c.slice(-252)),
    },
    n, returns, close: c
  };
}

function computeADX(h, l, c, p) {
  const n = c.length;
  const adx = new Array(n).fill(null);
  if (n < p * 2) return adx;

  const trArr = [0], pdm = [0], ndm = [0];
  for (let i = 1; i < n; i++) {
    trArr.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
    pdm.push(h[i]-h[i-1] > l[i-1]-l[i] && h[i]-h[i-1] > 0 ? h[i]-h[i-1] : 0);
    ndm.push(l[i-1]-l[i] > h[i]-h[i-1] && l[i-1]-l[i] > 0 ? l[i-1]-l[i] : 0);
  }

  let atr = trArr.slice(1, p+1).reduce((a,b)=>a+b,0);
  let pDI = pdm.slice(1, p+1).reduce((a,b)=>a+b,0);
  let nDI = ndm.slice(1, p+1).reduce((a,b)=>a+b,0);

  const dxArr = [];
  for (let i = p; i < n; i++) {
    if (i > p) {
      atr = atr - atr/p + trArr[i];
      pDI = pDI - pDI/p + pdm[i];
      nDI = nDI - nDI/p + ndm[i];
    }
    const pdi = atr > 0 ? 100*pDI/atr : 0;
    const ndi = atr > 0 ? 100*nDI/atr : 0;
    const dx = (pdi+ndi) > 0 ? 100*Math.abs(pdi-ndi)/(pdi+ndi) : 0;
    dxArr.push(dx);
    if (dxArr.length >= p) {
      adx[i] = dxArr.slice(-p).reduce((a,b)=>a+b,0)/p;
    }
  }
  return adx;
}

// ── QUANT SCORE ──
function computeQuantScore(ind, prices) {
  const c = ind.current;
  const signals = [];
  let bullScore = 0, totalWeight = 0;

  function addSignal(name, value, signal, weight, note) {
    const s = signal === 'bull' ? 1 : signal === 'bear' ? -1 : 0;
    bullScore += s * weight;
    totalWeight += weight;
    signals.push({ name, value, signal, weight, note });
  }

  // Trend signals (35% total)
  addSignal('Price vs SMA20', c.price > c.sma20 ? '+' + ((c.price/c.sma20-1)*100).toFixed(1)+'%' : ((c.price/c.sma20-1)*100).toFixed(1)+'%', c.price > c.sma20 ? 'bull' : 'bear', 7, 'Price above SMA20 is bullish');
  addSignal('Price vs SMA50', c.price > c.sma50 ? '+' + ((c.price/c.sma50-1)*100).toFixed(1)+'%' : ((c.price/c.sma50-1)*100).toFixed(1)+'%', c.price > c.sma50 ? 'bull' : 'bear', 7, '');
  addSignal('Price vs SMA200', c.price > c.sma200 ? '+' + ((c.price/c.sma200-1)*100).toFixed(1)+'%' : ((c.price/c.sma200-1)*100).toFixed(1)+'%', c.price > c.sma200 ? 'bull' : 'bear', 8, 'Golden/Death cross indicator');
  addSignal('MACD Cross', c.macdHist > 0 ? 'Positive' : 'Negative', c.macdHist > 0 ? 'bull' : 'bear', 8, 'MACD histogram: ' + (c.macdHist || 0).toFixed(2));
  addSignal('ROC (10d)', c.roc10 != null ? c.roc10.toFixed(1)+'%' : 'N/A', c.roc10 > 0 ? 'bull' : c.roc10 < 0 ? 'bear' : 'neutral', 5, '10-day rate of change');

  // Mean reversion (25% total)
  const bbPos = c.bbU && c.bbL ? (c.price - c.bbL)/(c.bbU - c.bbL) : 0.5;
  addSignal('Bollinger Pos', (bbPos*100).toFixed(0)+'%', bbPos < 0.2 ? 'bull' : bbPos > 0.8 ? 'bear' : 'neutral', 8, 'Position within BB');
  addSignal('Z-Score', c.zScore != null ? c.zScore.toFixed(2) : 'N/A', c.zScore < -1.5 ? 'bull' : c.zScore > 1.5 ? 'bear' : 'neutral', 9, 'Price deviation from 20d mean');
  const distFrom52H = ((c.high52 - c.price)/c.high52*100).toFixed(1);
  addSignal('52W Reversion', distFrom52H+'% from high', parseFloat(distFrom52H) > 20 ? 'bull' : parseFloat(distFrom52H) < 5 ? 'bear' : 'neutral', 8, '');

  // Volume (20% total)
  addSignal('OBV Trend', c.obv > c.obvPrev ? 'Rising' : 'Falling', c.obv > c.obvPrev ? 'bull' : 'bear', 7, 'On-balance volume');
  addSignal('Volume Spike', c.volZ > 2 ? 'High ('+c.volZ.toFixed(1)+'σ)' : 'Normal', c.volZ > 2 && c.price > ind.sma20[ind.n-1] ? 'bull' : c.volZ > 2 ? 'bear' : 'neutral', 6, 'Volume z-score');
  addSignal('CMF (20d)', c.cmf != null ? c.cmf.toFixed(3) : 'N/A', c.cmf > 0.05 ? 'bull' : c.cmf < -0.05 ? 'bear' : 'neutral', 7, 'Chaikin Money Flow');

  // Volatility/Risk (20% total)
  addSignal('RSI (14)', c.rsi != null ? c.rsi.toFixed(1) : 'N/A', c.rsi < 35 ? 'bull' : c.rsi > 65 ? 'bear' : 'neutral', 8, 'Oversold <35, Overbought >65');
  addSignal('ADX Strength', c.adx != null ? c.adx.toFixed(1) : 'N/A', c.adx > 25 ? 'bull' : 'neutral', 5, 'Trend strength >25 = strong');
  addSignal('Volatility', c.vol20 != null ? c.vol20.toFixed(1)+'%' : 'N/A', c.vol20 < 20 ? 'bull' : c.vol20 > 50 ? 'bear' : 'neutral', 7, 'Lower vol = stable trend');

  // Normalize to 0-100
  const rawScore = (bullScore / totalWeight + 1) / 2 * 100;
  const score = Math.max(0, Math.min(100, Math.round(rawScore)));

  let verdict;
  if (score >= 80) verdict = 'STRONG BUY';
  else if (score >= 60) verdict = 'BUY';
  else if (score >= 40) verdict = 'NEUTRAL';
  else if (score >= 20) verdict = 'SELL';
  else verdict = 'STRONG SELL';

  // Sharpe
  const r = ind.returns.slice(-252).filter(v => v !== 0);
  const meanR = r.reduce((a,b)=>a+b,0)/r.length;
  const stdR = Math.sqrt(r.reduce((a,b)=>a+(b-meanR)**2,0)/r.length);
  const sharpe = stdR > 0 ? ((meanR * 252 - 0.045) / (stdR * Math.sqrt(252))).toFixed(2) : 'N/A';

  return { score, verdict, signals, sharpe };
}

// ── MONTE CARLO ──
function runMonteCarlo(prices) {
  const c = prices.close;
  const n = c.length;
  const returns = [];
  for (let i = 1; i < n; i++) returns.push(Math.log(c[i]/c[i-1]));

  const mu = returns.reduce((a,b)=>a+b,0)/returns.length;
  const variance = returns.reduce((a,b)=>a+(b-mu)**2,0)/returns.length;
  const sigma = Math.sqrt(variance);
  const drift = mu - variance/2;
  const S0 = c[n-1];
  const steps = 30;
  const paths = 500;

  function randn() {
    let u=0,v=0;
    while(u===0) u=Math.random();
    while(v===0) v=Math.random();
    return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  }

  const allPaths = [];
  for (let p = 0; p < paths; p++) {
    const path = [S0];
    for (let t = 1; t <= steps; t++) {
      path.push(path[t-1] * Math.exp(drift + sigma * randn()));
    }
    allPaths.push(path);
  }

  // Percentiles at each step
  const percentiles = [];
  for (let t = 0; t <= steps; t++) {
    const vals = allPaths.map(p => p[t]).sort((a,b)=>a-b);
    percentiles.push({
      p5: vals[Math.floor(paths*0.05)],
      p25: vals[Math.floor(paths*0.25)],
      p50: vals[Math.floor(paths*0.50)],
      p75: vals[Math.floor(paths*0.75)],
      p95: vals[Math.floor(paths*0.95)],
    });
  }

  // Linear regression on last 90 days
  const histN = Math.min(90, n);
  const histClose = c.slice(n-histN);
  const xs = Array.from({length: histN}, (_,i) => i);
  const xMean = (histN-1)/2;
  const yMean = histClose.reduce((a,b)=>a+b,0)/histN;
  let num=0, den=0;
  xs.forEach((x,i) => { num += (x-xMean)*(histClose[i]-yMean); den += (x-xMean)**2; });
  const slope = den > 0 ? num/den : 0;
  const intercept = yMean - slope * xMean;
  const residuals = histClose.map((v,i) => v - (slope*i + intercept));
  const regStd = Math.sqrt(residuals.reduce((a,b)=>a+b**2,0)/histN);

  const regFwd = Array.from({length: steps+1}, (_,i) => {
    const x = histN - 1 + i;
    return slope * x + intercept;
  });

  return { allPaths, percentiles, regFwd, regStd, S0, steps, sigma, mu };
}

// ── SHOW DASHBOARD ──
function showDashboard(ticker, prices, volumes, dates, meta, ind, forecast, score, verdict, signals) {
  showWelcome(false);
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';

  // Ticker Bar
  document.getElementById('db-ticker').textContent = ticker;
  document.getElementById('db-company').textContent = meta.name;
  const price = meta.price;
  const change = price - meta.prevClose;
  const changePct = (change/meta.prevClose*100);
  document.getElementById('db-price').textContent = '$' + price.toFixed(2);
  const chEl = document.getElementById('db-change');
  chEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + ' (' + (changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%)';
  chEl.className = 'ticker-change ' + (change >= 0 ? 'up' : 'down');
  document.getElementById('db-volume').textContent = fmtNum(meta.volume || volumes[volumes.length-1]);
  document.getElementById('db-mktcap').textContent = meta.mktCap ? '$' + fmtBig(meta.mktCap) : 'N/A';
  document.getElementById('db-52h').textContent = '$' + (meta.high52 || ind.current.high52).toFixed(2);
  document.getElementById('db-52l').textContent = '$' + (meta.low52 || ind.current.low52).toFixed(2);
  document.getElementById('db-pe').textContent = meta.pe || 'N/A';
  document.getElementById('db-updated').textContent = '↻ ' + new Date().toLocaleTimeString();

  // Risk Metrics
  document.getElementById('rm-vol').textContent = ind.current.vol20 != null ? ind.current.vol20.toFixed(1) + '%' : 'N/A';
  const varDaily = price * (ind.current.vol20/100) / Math.sqrt(252) * 1.645;
  document.getElementById('rm-var').textContent = varDaily > 0 ? '$' + varDaily.toFixed(2) : 'N/A';
  document.getElementById('rm-atr').textContent = ind.current.atr != null ? '$' + ind.current.atr.toFixed(2) : 'N/A';
  
  const r = ind.returns.slice(-252).filter(v => v !== 0);
  const meanR = r.reduce((a,b)=>a+b,0)/r.length;
  const stdR = Math.sqrt(r.reduce((a,b)=>a+(b-meanR)**2,0)/r.length);
  const sharpe = stdR > 0 ? ((meanR * 252 - 0.045) / (stdR * Math.sqrt(252))).toFixed(2) : 'N/A';
  document.getElementById('rm-sharpe').textContent = sharpe;

  // Score gauge
  setTimeout(() => animateGauge(score, verdict), 300);

  // Signal table
  renderSignalTable(signals);

  // Charts
  renderPriceChart(dates, prices.close, ind);
  renderMacdChart(dates, ind);
  renderRsiChart(dates, ind);
  renderForecastChart(prices.close, forecast, dates);

  // Forecast stats
  const fc = forecast.percentiles[forecast.steps];
  const S0 = forecast.S0;
  document.getElementById('fc-current').textContent = '$' + S0.toFixed(2);
  document.getElementById('fc-median').textContent = '$' + fc.p50.toFixed(2);
  document.getElementById('fc-median-chg').textContent = fmtChg(fc.p50, S0);
  document.getElementById('fc-bull').textContent = '$' + fc.p75.toFixed(2);
  document.getElementById('fc-bull-chg').textContent = fmtChg(fc.p75, S0);
  document.getElementById('fc-bear').textContent = '$' + fc.p25.toFixed(2);
  document.getElementById('fc-bear-chg').textContent = fmtChg(fc.p25, S0);
}

function fmtChg(v, base) {
  const p = (v/base-1)*100;
  return (p >= 0 ? '+' : '') + p.toFixed(1) + '%';
}

function fmtNum(n) {
  if (!n) return 'N/A';
  if (n > 1e9) return (n/1e9).toFixed(1)+'B';
  if (n > 1e6) return (n/1e6).toFixed(1)+'M';
  if (n > 1e3) return (n/1e3).toFixed(1)+'K';
  return n.toString();
}

function fmtBig(n) {
  if (n > 1e12) return (n/1e12).toFixed(2)+'T';
  if (n > 1e9) return (n/1e9).toFixed(2)+'B';
  if (n > 1e6) return (n/1e6).toFixed(2)+'M';
  return n.toString();
}

// ── GAUGE ──
function animateGauge(score, verdict) {
  const fill = document.getElementById('gaugeFill');
  const text = document.getElementById('gaugeText');
  const verdictEl = document.getElementById('gaugeVerdict');
  const confFill = document.getElementById('confidenceFill');
  const confVal = document.getElementById('confidenceVal');

  const circumference = 251.2;
  const offset = circumference - (score/100) * circumference;
  
  const color = score >= 80 ? '#00ff88' : score >= 60 ? '#66ff99' : score >= 40 ? '#ffd700' : score >= 20 ? '#ff9500' : '#ff4466';
  
  fill.style.transition = 'stroke-dashoffset 1.5s cubic-bezier(0.4,0,0.2,1)';
  fill.style.stroke = color;
  fill.style.strokeDashoffset = offset;
  text.textContent = score;
  text.style.fill = color;

  const classes = { 'STRONG BUY': 'verdict-strong-buy', 'BUY': 'verdict-buy', 'NEUTRAL': 'verdict-neutral', 'SELL': 'verdict-sell', 'STRONG SELL': 'verdict-strong-sell' };
  verdictEl.textContent = verdict;
  verdictEl.className = 'gauge-verdict ' + (classes[verdict] || '');

  setTimeout(() => {
    confFill.style.width = score + '%';
    confVal.textContent = score + '%';
  }, 200);
}

// ── SIGNAL TABLE ──
function renderSignalTable(signals) {
  const tbody = document.getElementById('signalTableBody');
  tbody.innerHTML = signals.map(s => {
    const dotClass = s.signal === 'bull' ? 'dot-bull' : s.signal === 'bear' ? 'dot-bear' : 'dot-neut';
    const sigClass = s.signal === 'bull' ? 'sig-bullish' : s.signal === 'bear' ? 'sig-bearish' : 'sig-neutral';
    const sigText = s.signal === 'bull' ? '▲ BULL' : s.signal === 'bear' ? '▼ BEAR' : '◆ NEUTRAL';
    return `<tr>
      <td class="sig-indicator">${s.name}</td>
      <td style="color:var(--text2)">${s.value}</td>
      <td class="${sigClass}"><span class="sig-dot ${dotClass}"></span>${sigText}</td>
    </tr>`;
  }).join('');
}

// ── CHARTS ──
function destroyChart(ref) { if (ref) { try { ref.destroy(); } catch(e){} } }

function renderPriceChart(dates, closes, ind) {
  destroyChart(priceChart);
  const ctx = document.getElementById('priceChart').getContext('2d');
  const n = closes.length;
  
  // Buy/sell markers from MACD crossovers
  const buyPoints = [], sellPoints = [];
  for (let i = 1; i < n; i++) {
    if (ind.macdHist[i] > 0 && ind.macdHist[i-1] <= 0 && ind.rsi[i] < 60)
      buyPoints.push({x: dates[i], y: closes[i]});
    if (ind.macdHist[i] < 0 && ind.macdHist[i-1] >= 0 && ind.rsi[i] > 40)
      sellPoints.push({x: dates[i], y: closes[i]});
  }

  priceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'BB Upper', data: ind.bbUpper, borderColor: 'rgba(0,207,255,0.2)',
          borderWidth: 1, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(0,207,255,0.03)', tension: 0.3
        },
        {
          label: 'BB Lower', data: ind.bbLower, borderColor: 'rgba(0,207,255,0.2)',
          borderWidth: 1, pointRadius: 0, fill: false, tension: 0.3
        },
        {
          label: 'Price', data: closes, borderColor: '#00cfff', borderWidth: 2,
          pointRadius: 0, fill: false, tension: 0.1
        },
        {
          label: 'SMA20', data: ind.sma20, borderColor: '#ffd700',
          borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3, borderDash: []
        },
        {
          label: 'SMA50', data: ind.sma50, borderColor: '#ff9500',
          borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3
        },
        {
          label: 'SMA200', data: ind.sma200, borderColor: '#ff4466',
          borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3
        },
        {
          label: 'BUY', data: buyPoints, type: 'scatter',
          pointStyle: 'triangle', pointRadius: 8, backgroundColor: '#00ff88', borderColor: '#00ff88'
        },
        {
          label: 'SELL', data: sellPoints, type: 'scatter',
          pointStyle: 'triangle', rotation: 180, pointRadius: 8, backgroundColor: '#ff4466', borderColor: '#ff4466'
        }
      ]
    },
    options: chartOptions('Price & Indicators', true)
  });
}

function renderMacdChart(dates, ind) {
  destroyChart(macdChart);
  const ctx = document.getElementById('macdChart').getContext('2d');
  macdChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'Histogram', data: ind.macdHist, type: 'bar',
          backgroundColor: ind.macdHist.map(v => v > 0 ? 'rgba(0,255,136,0.5)' : 'rgba(255,68,102,0.5)'),
          borderColor: ind.macdHist.map(v => v > 0 ? '#00ff88' : '#ff4466'),
          borderWidth: 1
        },
        {
          label: 'MACD', data: ind.macdLine, type: 'line',
          borderColor: '#00cfff', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3
        },
        {
          label: 'Signal', data: ind.macdSignal, type: 'line',
          borderColor: '#ff9500', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3
        }
      ]
    },
    options: chartOptions('MACD', false)
  });
}

function renderRsiChart(dates, ind) {
  destroyChart(rsiChart);
  const ctx = document.getElementById('rsiChart').getContext('2d');
  rsiChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'RSI', data: ind.rsi, borderColor: '#8866ff',
          borderWidth: 2, pointRadius: 0, fill: false, tension: 0.3
        },
        {
          label: 'OB', data: new Array(dates.length).fill(70),
          borderColor: 'rgba(255,68,102,0.4)', borderWidth: 1, pointRadius: 0,
          fill: false, borderDash: [5,5]
        },
        {
          label: 'OS', data: new Array(dates.length).fill(30),
          borderColor: 'rgba(0,255,136,0.4)', borderWidth: 1, pointRadius: 0,
          fill: false, borderDash: [5,5]
        }
      ]
    },
    options: { ...chartOptions('RSI', false), scales: { ...chartOptions('RSI',false).scales, y: { ...chartOptions('RSI',false).scales.y, min: 0, max: 100 } } }
  });
}

function renderForecastChart(closes, forecast, dates) {
  destroyChart(forecastChart);
  const ctx = document.getElementById('forecastChart').getContext('2d');
  const histN = 30;
  const histClose = closes.slice(-histN);
  const histDates = dates.slice(-histN);

  // Forward dates (approximate)
  const lastDate = new Date();
  const fwdDates = Array.from({length: forecast.steps+1}, (_,i) => {
    const d = new Date(lastDate);
    d.setDate(d.getDate() + i);
    return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  });

  const allLabels = [...histDates, ...fwdDates.slice(1)];

  // Build percentile arrays (padded with nulls for history)
  const pad = new Array(histN-1).fill(null);
  const p50 = [...pad, ...forecast.percentiles.map(p => p.p50)];
  const p25 = [...pad, ...forecast.percentiles.map(p => p.p25)];
  const p75 = [...pad, ...forecast.percentiles.map(p => p.p75)];
  const p5  = [...pad, ...forecast.percentiles.map(p => p.p5)];
  const p95 = [...pad, ...forecast.percentiles.map(p => p.p95)];

  // Regression channel
  const regLine = [...pad, ...forecast.regFwd];
  const regUp = [...pad, ...forecast.regFwd.map(v => v + forecast.regStd)];
  const regDn = [...pad, ...forecast.regFwd.map(v => v - forecast.regStd)];

  const histData = [...histClose, ...new Array(forecast.steps).fill(null)];

  forecastChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: allLabels,
      datasets: [
        { label: 'Price (30d)', data: histData, borderColor: '#00cfff', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 },
        { label: 'Reg Upper', data: regUp, borderColor: 'rgba(255,215,0,0.3)', borderWidth: 1, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(255,215,0,0.05)', tension: 0.3 },
        { label: 'Reg Lower', data: regDn, borderColor: 'rgba(255,215,0,0.3)', borderWidth: 1, pointRadius: 0, fill: false, tension: 0.3 },
        { label: 'Reg Trend', data: regLine, borderColor: 'rgba(255,215,0,0.6)', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3, borderDash: [6,3] },
        { label: 'P95', data: p95, borderColor: 'rgba(0,255,136,0.15)', borderWidth: 1, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(0,255,136,0.04)', tension: 0.4 },
        { label: 'P75 Bull', data: p75, borderColor: 'rgba(0,255,136,0.4)', borderWidth: 1.5, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(0,255,136,0.08)', tension: 0.4 },
        { label: 'P50 Median', data: p50, borderColor: '#ffffff', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.4 },
        { label: 'P25 Bear', data: p25, borderColor: 'rgba(255,68,102,0.4)', borderWidth: 1.5, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(255,68,102,0.08)', tension: 0.4 },
        { label: 'P5', data: p5, borderColor: 'rgba(255,68,102,0.15)', borderWidth: 1, pointRadius: 0, fill: false, tension: 0.4 },
      ]
    },
    options: chartOptions('30-Day Monte Carlo Forecast', true)
  });
}

function chartOptions(label, showLegend) {
  return {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { intersect: false, mode: 'index' },
    plugins: {
      legend: {
        display: showLegend,
        labels: { color: '#7a90b0', font: { family: 'Share Tech Mono', size: 10 }, boxWidth: 12, padding: 10 }
      },
      tooltip: {
        backgroundColor: 'rgba(8,13,26,0.95)',
        borderColor: '#1a2540',
        borderWidth: 1,
        titleColor: '#00cfff',
        bodyColor: '#c8d8f0',
        titleFont: { family: 'Share Tech Mono', size: 11 },
        bodyFont: { family: 'Share Tech Mono', size: 11 },
        callbacks: {
          label: ctx => {
            const v = ctx.parsed.y;
            if (v == null) return null;
            return ` ${ctx.dataset.label}: ${typeof v === 'number' ? v.toFixed(2) : v}`;
          }
        }
      }
    },
    scales: {
      x: {
        ticks: {
          color: '#3a5070', font: { family: 'Share Tech Mono', size: 9 },
          maxTicksLimit: 10, maxRotation: 0
        },
        grid: { color: 'rgba(26,37,64,0.5)', borderColor: '#1a2540' }
      },
      y: {
        position: 'right',
        ticks: { color: '#3a5070', font: { family: 'Share Tech Mono', size: 9 } },
        grid: { color: 'rgba(26,37,64,0.5)', borderColor: '#1a2540' }
      }
    }
  };
}

// ── AI CONSULTANT ──
async function autoConsult(ticker, score, verdict, signals, ind, forecast, meta) {
  const c = ind.current;
  const fc = forecast.percentiles[forecast.steps];
  
  const context = `
STOCK: ${ticker} | PRICE: $${c.price.toFixed(2)}
QUANT SCORE: ${score}/100 | VERDICT: ${verdict}

TECHNICAL SIGNALS:
${signals.map(s => `  ${s.name}: ${s.value} → ${s.signal.toUpperCase()}`).join('\n')}

RISK METRICS:
  Historical Volatility (20d ann.): ${c.vol20 != null ? c.vol20.toFixed(1)+'%' : 'N/A'}
  ATR (14): $${c.atr != null ? c.atr.toFixed(2) : 'N/A'}
  RSI: ${c.rsi != null ? c.rsi.toFixed(1) : 'N/A'}
  Z-Score: ${c.zScore != null ? c.zScore.toFixed(2) : 'N/A'}

30-DAY MONTE CARLO FORECAST (500 paths, GBM):
  Bear Case (25th %ile): $${fc.p25.toFixed(2)} (${fmtChg(fc.p25, c.price)})
  Median (50th %ile):    $${fc.p50.toFixed(2)} (${fmtChg(fc.p50, c.price)})
  Bull Case (75th %ile): $${fc.p75.toFixed(2)} (${fmtChg(fc.p75, c.price)})

MOMENTUM:
  SMA20: $${c.sma20 != null ? c.sma20.toFixed(2) : 'N/A'} | SMA50: $${c.sma50 != null ? c.sma50.toFixed(2) : 'N/A'} | SMA200: $${c.sma200 != null ? c.sma200.toFixed(2) : 'N/A'}
  MACD Histogram: ${c.macdHist != null ? c.macdHist.toFixed(3) : 'N/A'}
  CMF: ${c.cmf != null ? c.cmf.toFixed(3) : 'N/A'}
  ADX: ${c.adx != null ? c.adx.toFixed(1) : 'N/A'}
`;

  chatHistory = [];
  const systemPrompt = `You are an elite quantitative analyst at a top-tier hedge fund, combining the mathematical rigor of Renaissance Technologies with the multi-strategy approach of Citadel. You have been given a complete quantitative analysis of a stock. Provide a sharp, precise, institutional-grade investment analysis.

Structure your response EXACTLY as follows:
1. **INVESTMENT THESIS** (2-3 sentences — what the quant signals say)
2. **KEY RISK FACTORS** (2-3 bullets)
3. **ENTRY ZONE & STOP-LOSS** (specific price levels)
4. **POSITION SIZING** (% of portfolio based on volatility using Kelly-inspired logic)
5. **PRICE LEVELS TO WATCH** (support/resistance, key triggers)

Be direct, reference specific signal values, use professional finance language. Keep it sharp and actionable.`;

  const userMsg = `Analyze this stock based on the following quantitative data:\n\n${context}`;
  
  addChatMsg('ai', '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>', 'typing-msg');
  
  chatHistory.push({ role: 'user', content: userMsg });
  
  try {
    const reply = await callGemini(systemPrompt, chatHistory);
    chatHistory.push({ role: 'assistant', content: reply });
    document.getElementById('typing-msg')?.remove();
    addChatMsg('ai', formatMarkdown(reply));
  } catch (e) {
    document.getElementById('typing-msg')?.remove();
    addChatMsg('ai', `⚠ AI Consultant unavailable. Please add your Google Gemini API key at the top of the file (GEMINI_API_KEY). Get a free key at aistudio.google.com`);
  }
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg || !currentAnalysis) return;

  input.value = '';
  document.getElementById('sendBtn').disabled = true;
  document.getElementById('chatStatus').textContent = 'Analyzing...';

  addChatMsg('user', msg);
  chatHistory.push({ role: 'user', content: msg });

  const typingEl = addChatMsg('ai', '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>', 'typing-msg2');

  const systemPrompt = `You are an elite quant analyst. The user is asking follow-up questions about ${currentAnalysis.ticker} stock analysis with Quant Score ${currentAnalysis.score}/100 (${currentAnalysis.verdict}). Be direct, precise, and quantitative. Reference specific metrics when relevant.`;

  try {
    const reply = await callGemini(systemPrompt, chatHistory);
    chatHistory.push({ role: 'assistant', content: reply });
    document.getElementById('typing-msg2')?.remove();
    addChatMsg('ai', formatMarkdown(reply));
  } catch(e) {
    document.getElementById('typing-msg2')?.remove();
    addChatMsg('ai', '⚠ API error: ' + e.message + '. Ensure your API key is set correctly.');
  }

  document.getElementById('sendBtn').disabled = false;
  document.getElementById('chatStatus').textContent = 'Ready';
}

async function callGemini(system, messages) {
  const geminiContents = messages.map(m => ({
    role: m.role === 'assistant' ? 'model' : 'user',
    parts: [{ text: m.content }]
  }));

  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        system_instruction: { parts: [{ text: system }] },
        contents: geminiContents,
        generationConfig: { maxOutputTokens: 1000, temperature: 0.7 }
      })
    }
  );

  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    throw new Error(err.error?.message || 'Gemini API request failed (' + response.status + ')');
  }

  const data = await response.json();
  return data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response received.';
}

function formatMarkdown(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--cyan)">$1</strong>')
    .replace(/\*(.*?)\*/g, '<em style="color:var(--text)">$1</em>')
    .replace(/^(\d+)\. /gm, '<br><span style="color:var(--green)">$1.</span> ')
    .replace(/^- /gm, '<br>• ')
    .replace(/\n/g, '<br>');
}

function addChatMsg(role, content, id) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  if (id) div.id = id;
  const avatar = role === 'ai' ? 'AI' : 'YOU';
  div.innerHTML = `<div class="msg-avatar">${avatar}</div><div class="msg-content">${content}</div>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}

// ── UI HELPERS ──
function showLoading(ticker) {
  document.getElementById('welcome-screen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'none';
  const ls = document.getElementById('loading-screen');
  ls.style.display = 'flex';
  document.getElementById('loadingTicker').textContent = ticker;
  ['step1','step2','step3','step4','step5'].forEach(id => {
    document.getElementById(id).className = 'loading-step';
  });
}

function setStep(n) {
  for (let i = 1; i < n; i++) document.getElementById('step'+i).className = 'loading-step done';
  document.getElementById('step'+n).className = 'loading-step active';
}

function showWelcome(show=true) {
  document.getElementById('welcome-screen').style.display = show ? 'flex' : 'none';
  document.getElementById('loading-screen').style.display = 'none';
  if (!show) return;
  document.getElementById('dashboard').style.display = 'none';
}

function showError(msg) {
  const el = document.getElementById('errorBanner');
  el.textContent = '⚠ ' + msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 8000);
}

function hideError() {
  document.getElementById('errorBanner').style.display = 'none';
}

function setStatus(msg) {
  document.getElementById('statusText').textContent = msg;
}
</script>
</body>
</html>
